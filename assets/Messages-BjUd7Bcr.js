import{c as L,r as t,av as je,j as e,ah as se,R as Ne,ap as ae,I as ve,aw as we,C as ke,e as re,a0 as Se,ax as Ce,am as Re,X as te,U as f,d as le,ay as Ee,an as Ie,az as Ue,Z as Me,w as ne,aA as Oe,b as Le,aB as Be}from"./index-Ba5jVD6p.js";import{P as O}from"./paperclip-CYuFmfPe.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=L("ArrowDownUp",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"m21 8-4-4-4 4",key:"1c9v7m"}],["path",{d:"M17 4v16",key:"7dpous"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=L("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=L("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]),Fe=({user:i})=>{const[n,h]=t.useState("INBOX"),[j,B]=t.useState([]),[ce,ie]=t.useState([]),[d,g]=t.useState(null),[N,A]=t.useState(!1),[v,oe]=t.useState([]),[x,P]=t.useState([]),[T,$]=t.useState(!1),w=t.useRef(null),[o,k]=t.useState("USER"),[S,D]=t.useState(""),[F,X]=t.useState(""),[z,q]=t.useState(""),[G,_]=t.useState(!1),[C,R]=t.useState([]),[K,u]=t.useState(""),b=t.useRef(null),[E,V]=t.useState(""),[Z,xe]=t.useState("newest"),[p,m]=t.useState(1),[y,ge]=t.useState(10);t.useEffect(()=>{I()},[i,n]),t.useEffect(()=>{m(1),V("")},[n]),t.useEffect(()=>{(async()=>{try{const a=await ne("app_users"),r=await ne("personnel"),l=a.map(c=>{const ee=r.find(fe=>fe.id===c.personnel_id);return{id:c.id,name:ee?ee.full_name:c.username}});oe(l)}catch(a){console.error("Error loading users for messages:",a)}})()},[]),t.useEffect(()=>{const s=a=>{w.current&&!w.current.contains(a.target)&&$(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const I=async()=>{A(!0);try{const{inbox:s,sent:a}=await je(i.id,i.role);B(s),ie(a)}catch(s){console.error("Failed to load messages",s)}finally{A(!1)}},me=async s=>{g(s),n==="INBOX"&&!s.readBy.includes(i.id)&&(B(a=>a.map(r=>r.id===s.id?{...r,readBy:[...r.readBy,i.id]}:r)),await Be(s,i.id))},H=s=>{P(a=>a.includes(s)?a.filter(r=>r!==s):[...a,s])},he=s=>new Promise((a,r)=>{const l=new FileReader;l.readAsDataURL(s),l.onload=()=>{a(l.result)},l.onerror=c=>{r(c)}}),ue=s=>{if(s.target.files&&s.target.files.length>0){const a=Array.from(s.target.files),r=5*1024*1024,l=a.filter(c=>c.size>r?(alert(`فایل ${c.name} بیشتر از ۵ مگابایت است و حذف شد.`),!1):!0);R(c=>[...c,...l])}b.current&&(b.current.value="")},be=s=>{R(a=>a.filter((r,l)=>l!==s))},pe=async s=>{s.preventDefault();let a="";if(o==="USER"){if(x.length===0){alert("لطفا حداقل یک گیرنده را انتخاب کنید");return}a=x}else if(o==="ALL")a="ALL";else{if(!S){alert("لطفا گروه را مشخص کنید");return}a=S}_(!0),u("");try{const r=[];for(const l of C){const c=await he(l);r.push({name:l.name,size:l.size,type:l.type,data:c})}await Oe(i,a,o,F,z,r),u("پیام با موفقیت ارسال شد"),X(""),q(""),D(""),P([]),R([]),I(),setTimeout(()=>{u(""),h("SENT")},3e3)}catch(r){const l=(r==null?void 0:r.message)||JSON.stringify(r)||"خطای ناشناخته";alert("خطا در ارسال پیام: "+l),console.error(r)}finally{_(!1)}},ye=s=>s.readBy&&s.readBy.length>0?e.jsx("span",{title:"خوانده شده",className:"flex text-blue-500",children:e.jsx(de,{className:"w-4 h-4"})}):e.jsx("span",{title:"ارسال شده",className:"flex text-gray-400",children:e.jsx(Le,{className:"w-4 h-4"})}),U=s=>{if(s.receiverType==="ALL")return"همه کاربران";if(s.receiverType==="GROUP")return`گروه ${s.receiverId}`;const a=v.find(r=>r.id===s.receiverId);return a?a.name:"کاربر"},J=(()=>{let s=n==="INBOX"?j:ce;if(E){const a=E.toLowerCase();s=s.filter(r=>r.subject.toLowerCase().includes(a)||r.body.toLowerCase().includes(a)||r.senderName.toLowerCase().includes(a)||n==="SENT"&&U(r).toLowerCase().includes(a))}return s.sort((a,r)=>Z==="newest"?r.createdAt.localeCompare(a.createdAt):a.createdAt.localeCompare(r.createdAt)),s})(),M=J.length,Q=Math.ceil(M/y),W=(p-1)*y,Y=J.slice(W,W+y);return e.jsxs("div",{className:"max-w-7xl mx-auto h-[calc(100vh-100px)] flex flex-col md:flex-row gap-6 p-4",children:[e.jsxs("div",{className:"w-full md:w-64 flex-shrink-0 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 space-y-2",children:[e.jsxs("button",{onClick:()=>{h("COMPOSE"),g(null),u("")},className:"w-full bg-blue-600 text-white py-2 rounded-lg shadow hover:bg-blue-700 transition flex items-center justify-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"})," ارسال پیام جدید"]}),e.jsxs("button",{onClick:I,className:"w-full bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-2 rounded-lg border dark:border-gray-600 hover:bg-gray-50 transition flex items-center justify-center gap-2",children:[e.jsx(Ne,{className:`w-4 h-4 ${N?"animate-spin":""}`})," بروزرسانی"]})]}),e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("button",{onClick:()=>{h("INBOX"),g(null)},className:`w-full flex items-center justify-between p-3 rounded-lg text-sm transition-colors ${n==="INBOX"?"bg-primary/10 text-primary font-bold":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4"})," صندوق دریافت"]}),j.filter(s=>!s.readBy.includes(i.id)).length>0&&e.jsx("span",{className:"bg-red-500 text-white px-2 py-0.5 rounded-full text-xs",children:j.filter(s=>!s.readBy.includes(i.id)).length})]}),e.jsx("button",{onClick:()=>{h("SENT"),g(null)},className:`w-full flex items-center justify-between p-3 rounded-lg text-sm transition-colors ${n==="SENT"?"bg-primary/10 text-primary font-bold":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"})," صندوق ارسال"]})})]})]}),e.jsxs("div",{className:"flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col",children:[n==="COMPOSE"&&e.jsxs("div",{className:"p-6 overflow-y-auto",children:[e.jsxs("h2",{className:"text-xl font-bold mb-6 flex items-center gap-2",children:[e.jsx(we,{className:"w-6 h-6 text-primary"})," ارسال پیام جدید"]}),K&&e.jsxs("div",{className:"mb-4 bg-green-100 border border-green-200 text-green-800 px-4 py-3 rounded-lg flex items-center gap-2 animate-fadeIn",children:[e.jsx(ke,{className:"w-5 h-5"}),K]}),e.jsxs("form",{onSubmit:pe,className:"space-y-4 max-w-2xl",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold mb-1",children:"نوع گیرنده"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>k("USER"),className:`flex-1 py-2 rounded-lg border text-sm flex items-center justify-center gap-1 ${o==="USER"?"bg-blue-50 border-blue-500 text-blue-700":"border-gray-200"}`,children:[e.jsx(re,{className:"w-4 h-4"})," فرد"]}),e.jsxs("button",{type:"button",onClick:()=>k("GROUP"),className:`flex-1 py-2 rounded-lg border text-sm flex items-center justify-center gap-1 ${o==="GROUP"?"bg-blue-50 border-blue-500 text-blue-700":"border-gray-200"}`,children:[e.jsx(Se,{className:"w-4 h-4"})," گروه"]}),e.jsxs("button",{type:"button",onClick:()=>k("ALL"),className:`flex-1 py-2 rounded-lg border text-sm flex items-center justify-center gap-1 ${o==="ALL"?"bg-blue-50 border-blue-500 text-blue-700":"border-gray-200"}`,children:[e.jsx(Ce,{className:"w-4 h-4"})," همه"]})]})]}),o==="USER"&&e.jsxs("div",{className:"relative",ref:w,children:[e.jsx("label",{className:"block text-sm font-bold mb-1",children:"انتخاب کاربران"}),e.jsxs("div",{className:"w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none cursor-pointer flex items-center justify-between",onClick:()=>$(!T),children:[e.jsx("span",{className:"text-sm truncate",children:x.length>0?`${x.length} نفر انتخاب شده`:"انتخاب کنید..."}),e.jsx(Re,{className:"w-4 h-4 text-gray-500"})]}),T&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto p-1",children:v.map(s=>e.jsxs("div",{onClick:()=>H(s.id),className:"flex items-center gap-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:x.includes(s.id),readOnly:!0,className:"w-4 h-4 rounded text-primary focus:ring-primary pointer-events-none"}),e.jsx("span",{className:"text-sm",children:s.name})]},s.id))}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:x.map(s=>{const a=v.find(r=>r.id===s);return a?e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center gap-1",children:[a.name,e.jsx("button",{type:"button",onClick:()=>H(s),className:"hover:text-red-600",children:e.jsx(te,{className:"w-3 h-3"})})]},s):null})})]}),o==="GROUP"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold mb-1",children:"انتخاب گروه کاربری"}),e.jsxs("select",{className:"w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none",value:S,onChange:s=>D(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"انتخاب کنید..."}),e.jsx("option",{value:f.ADMIN,children:"مدیران سیستم"}),e.jsx("option",{value:f.MANAGER,children:"مدیران فنی"}),e.jsx("option",{value:f.USER,children:"پرسنل اجرایی"}),e.jsx("option",{value:f.STOREKEEPER,children:"انبارداران"})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-bold mb-1",children:["موضوع پیام ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:F,onChange:s=>X(s.target.value),className:"w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",required:!0,placeholder:"عنوان پیام..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-bold mb-1",children:["متن پیام ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:z,onChange:s=>q(s.target.value),className:"w-full p-3 border rounded-lg h-40 bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary resize-none",required:!0,placeholder:"متن پیام خود را بنویسید..."})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>{var s;return(s=b.current)==null?void 0:s.click()},className:"flex items-center gap-2 text-gray-500 hover:text-gray-700 border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg transition hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx(O,{className:"w-4 h-4"})," پیوست فایل"]}),e.jsx("span",{className:"text-xs text-gray-400",children:"حداکثر حجم هر فایل: ۵ مگابایت"}),e.jsx("input",{type:"file",ref:b,multiple:!0,className:"hidden",onChange:ue})]}),C.length>0&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:C.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full text-xs border border-gray-200 dark:border-gray-600",children:[e.jsx("span",{className:"truncate max-w-[150px]",children:s.name}),e.jsxs("span",{className:"text-gray-400",children:["(",(s.size/1024/1024).toFixed(2)," MB)"]}),e.jsx("button",{type:"button",onClick:()=>be(a),className:"text-red-500 hover:bg-red-100 rounded-full p-0.5",children:e.jsx(te,{className:"w-3 h-3"})})]},a))})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs("button",{disabled:G,type:"submit",className:"bg-primary text-white px-8 py-3 rounded-xl shadow-lg hover:bg-red-800 transition flex items-center gap-2 disabled:opacity-50",children:[G?e.jsx(le,{className:"w-5 h-5 animate-spin"}):e.jsx(se,{className:"w-5 h-5"})," ارسال پیام"]})})]})]}),(n==="INBOX"||n==="SENT")&&e.jsxs("div",{className:"flex h-full flex-col md:flex-row",children:[e.jsxs("div",{className:`${d?"hidden md:flex md:w-1/3 border-l dark:border-gray-700":"w-full flex"} flex-col h-full bg-white dark:bg-gray-800`,children:[e.jsxs("div",{className:"p-3 border-b dark:border-gray-700 space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"جستجو...",value:E,onChange:s=>{V(s.target.value),m(1)},className:"w-full pr-9 pl-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm outline-none focus:ring-1 focus:ring-primary"})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsxs("button",{onClick:()=>xe(s=>s==="newest"?"oldest":"newest"),className:"flex items-center gap-1 text-gray-500 hover:text-primary transition",children:[e.jsx(Ae,{className:"w-3 h-3"}),Z==="newest"?"جدیدترین":"قدیمی‌ترین"]}),e.jsxs("span",{className:"text-gray-400",children:[M," پیام"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[N&&e.jsxs("div",{className:"p-10 text-center text-gray-400",children:[e.jsx(le,{className:"w-8 h-8 mx-auto animate-spin mb-2"}),e.jsx("span",{children:"در حال دریافت اطلاعات..."})]}),!N&&Y.length===0&&e.jsxs("div",{className:"text-center p-10 text-gray-400",children:[e.jsx(ae,{className:"w-12 h-12 mx-auto mb-3 opacity-20"}),e.jsx("p",{children:"موردی یافت نشد"})]}),Y.map(s=>{const a=n==="INBOX"&&!s.readBy.includes(i.id);return e.jsxs("div",{onClick:()=>me(s),className:`p-4 border-b dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative
                                            ${(d==null?void 0:d.id)===s.id?"bg-blue-50 dark:bg-blue-900/20":""}
                                            ${a?"bg-white":"bg-gray-50/30 dark:bg-gray-800/50"}
                                        `,children:[a&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-1 bg-blue-500"}),e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("span",{className:`text-sm ${a?"font-black text-black dark:text-white":"font-medium text-gray-600 dark:text-gray-400"}`,children:n==="INBOX"?s.senderName:U(s)}),e.jsx("span",{className:"text-[10px] text-gray-400",dir:"ltr",children:s.createdAt})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:`text-sm truncate pr-2 ${a?"font-black text-gray-900 dark:text-white":"font-normal text-gray-600 dark:text-gray-400"}`,children:s.subject}),n==="SENT"&&ye(s)]}),e.jsx("p",{className:`text-xs mt-1 truncate ${a?"text-gray-800 dark:text-gray-300":"text-gray-400"}`,children:s.body}),s.attachments&&s.attachments.length>0&&e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs text-gray-400",children:[e.jsx(O,{className:"w-3 h-3"}),e.jsxs("span",{children:[s.attachments.length," پیوست"]})]})]},s.id)})]}),M>0&&e.jsxs("div",{className:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex justify-between items-center text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:y,onChange:s=>{ge(Number(s.target.value)),m(1)},className:"bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-1 outline-none",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"}),e.jsx("option",{value:200,children:"200"})]}),e.jsx("span",{className:"text-gray-500",children:"سطر"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{disabled:p===1,onClick:()=>m(s=>s-1),className:"p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded disabled:opacity-30",children:e.jsx(Ie,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-mono",children:[p," / ",Q||1]}),e.jsx("button",{disabled:p>=Q,onClick:()=>m(s=>s+1),className:"p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded disabled:opacity-30",children:e.jsx(Ue,{className:"w-4 h-4"})})]})]})]}),d?e.jsxs("div",{className:"flex-1 flex flex-col h-full bg-gray-50 dark:bg-gray-900/50",children:[e.jsxs("div",{className:"p-6 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:d.subject}),e.jsx("button",{onClick:()=>g(null),className:"md:hidden text-sm text-blue-600",children:"بازگشت"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-300",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-500",children:n==="INBOX"?d.senderName[0]:e.jsx(re,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("span",{className:"font-bold",children:n==="INBOX"?d.senderName:"شما"})}),e.jsx("p",{className:"text-xs opacity-70",dir:"ltr",children:d.createdAt})]})]}),n==="SENT"&&e.jsxs("div",{className:"mt-4 pt-3 border-t dark:border-gray-700 text-xs text-gray-500",children:["گیرنده: ",U(d),d.readBy.length>0&&e.jsxs("span",{className:"mr-2 text-blue-600 flex items-center gap-1 inline-flex",children:[e.jsx(de,{className:"w-3 h-3"})," خوانده شده"]})]})]}),e.jsxs("div",{className:"p-6 flex-1 overflow-y-auto",children:[e.jsx("p",{className:"whitespace-pre-wrap leading-relaxed text-gray-800 dark:text-gray-200",children:d.body}),d.attachments&&d.attachments.length>0&&e.jsxs("div",{className:"mt-8 border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsxs("h4",{className:"text-sm font-bold mb-3 flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4"})," فایل‌های پیوست شده"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:d.attachments.map((s,a)=>e.jsxs("div",{className:"flex items-center p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition",children:[e.jsx("div",{className:"bg-gray-100 dark:bg-gray-700 p-2 rounded-lg text-gray-500",children:e.jsx(Pe,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 px-3 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium truncate",title:s.name,children:s.name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[(s.size/1024).toFixed(1)," KB"]})]}),e.jsx("a",{href:s.data,download:s.name,className:"text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-full transition",title:"دانلود",children:e.jsx(Me,{className:"w-4 h-4"})})]},a))})]})]})]}):e.jsx("div",{className:"hidden md:flex flex-1 items-center justify-center text-gray-400 bg-gray-50 dark:bg-gray-900/50"})]})]})]})};export{Fe as Messages,Fe as default};
