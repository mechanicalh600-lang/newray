import{r as n,O as R,a1 as T,j as t,a2 as F,A as M,R as P,Y as B,V,F as z,s as b}from"./index-Ba5jVD6p.js";const p="import_tool_profiles_v1",j=(a,d)=>{if(!a)return d;try{return JSON.parse(a)}catch{return d}},_=a=>({referenceQueries:[],mappings:[],dependencyRules:[],batchSize:200,moduleKey:a}),L=a=>({id:a.id,title:a.title||"",module_key:a.module_key||"",target_table:a.target_table||a.module_key||"",config_json:a.config_json||_(a.module_key||""),is_active:a.is_active!==!1,notes:a.notes||"",created_at:a.created_at,updated_at:a.updated_at}),K=(a,d)=>{const c=(a||"").trim(),r=(d||"").trim();return!c&&!r?"-":!r||c===r?c||r:c?`${c} / ${r}`:r},Y=()=>{const[a,d]=n.useState([]),[c,r]=n.useState(null),[o,i]=n.useState({title:"پروفایل تجهیزات",module_key:"equipment",target_table:"equipment",config_json:_("equipment"),is_active:!0,notes:""}),[v,m]=n.useState(JSON.stringify(_("equipment"),null,2)),[q,N]=n.useState(!1),[k,h]=n.useState(!1),[S,u]=n.useState(""),[w,x]=n.useState(""),[y,C]=n.useState(!1),E=n.useMemo(()=>R.map(e=>({value:e,label:T[e]})),[]),f=async()=>{N(!0),x(""),u("");try{const{data:e,error:s}=await b.from("import_tool_profiles").select("*").order("updated_at",{ascending:!1});if(s)throw s;const l=(e||[]).map(L);if(d(l),C(!1),l.length>0){const g=l[0];r(g.id||null),i(g),m(JSON.stringify(g.config_json||{},null,2))}}catch(e){const s=j(localStorage.getItem(p),[]);if(d(s),C(!0),x(`جدول import_tool_profiles در دسترس نیست. برای ادامه موقت از LocalStorage استفاده می‌شود. جزئیات: ${(e==null?void 0:e.message)||"unknown"}`),s.length>0){const l=L(s[0]);r(l.id||null),i(l),m(JSON.stringify(l.config_json||{},null,2))}}finally{N(!1)}};n.useEffect(()=>{f()},[]);const O=()=>{const e={title:"پروفایل جدید",module_key:"equipment",target_table:"equipment",config_json:_("equipment"),is_active:!0,notes:""};r(null),i(e),m(JSON.stringify(e.config_json,null,2))},I=e=>{r(e.id||null),i(e),m(JSON.stringify(e.config_json||{},null,2))},J=async()=>{h(!0),x(""),u("");try{const e=JSON.parse(v||"{}"),s={...o,config_json:e};if(y){const l=j(localStorage.getItem(p),[]),g=s.id||`local-${Date.now()}`,A=[...l.filter(D=>D.id!==g),{...s,id:g,updated_at:new Date().toISOString()}];localStorage.setItem(p,JSON.stringify(A)),u("پروفایل در LocalStorage ذخیره شد."),await f();return}if(s.is_active&&await b.from("import_tool_profiles").update({is_active:!1}).eq("module_key",s.module_key),s.id){const{error:l}=await b.from("import_tool_profiles").update({title:s.title,module_key:s.module_key,target_table:s.target_table,config_json:s.config_json,notes:s.notes||null,is_active:s.is_active,updated_at:new Date().toISOString()}).eq("id",s.id);if(l)throw l}else{const{error:l}=await b.from("import_tool_profiles").insert([{title:s.title,module_key:s.module_key,target_table:s.target_table,config_json:s.config_json,notes:s.notes||null,is_active:s.is_active}]);if(l)throw l}u("پروفایل با موفقیت ذخیره شد."),await f()}catch(e){x(`خطا در ذخیره پروفایل: ${(e==null?void 0:e.message)||"invalid config json"}`)}finally{h(!1)}},$=async()=>{if(o.id&&window.confirm("این پروفایل حذف شود؟")){h(!0),x("");try{if(y){const s=j(localStorage.getItem(p),[]).filter(l=>l.id!==o.id);localStorage.setItem(p,JSON.stringify(s))}else{const{error:e}=await b.from("import_tool_profiles").delete().eq("id",o.id);if(e)throw e}u("پروفایل حذف شد."),O(),await f()}catch(e){x(`خطا در حذف: ${(e==null?void 0:e.message)||"unknown"}`)}finally{h(!1)}}};return t.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 pb-20",children:[t.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-11 h-11 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center",children:t.jsx(F,{className:"w-6 h-6"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-black",children:"تنظیمات ابزار ورود اطلاعات"}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تعریف پروفایل import برای دانلود نمونه اکسل وابستگی‌دار و نگاشت هوشمند ستون‌ها"})]})]})}),y&&t.jsxs("div",{className:"rounded-xl border border-amber-200 bg-amber-50 text-amber-800 p-3 text-sm flex items-start gap-2",children:[t.jsx(M,{className:"w-4 h-4 mt-0.5 shrink-0"}),"جدول Supabase برای پروفایل‌ها هنوز آماده نیست. ذخیره‌ها فعلا لوکال هستند."]}),w&&t.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 text-red-700 p-3 text-sm",children:w}),S&&t.jsx("div",{className:"rounded-xl border border-green-200 bg-green-50 text-green-700 p-3 text-sm",children:S}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"font-bold text-sm",children:"پروفایل‌ها"}),t.jsx("button",{onClick:f,className:"p-2 rounded-lg bg-gray-100 hover:bg-gray-200",title:"بازخوانی",children:t.jsx(P,{className:`w-4 h-4 ${q?"animate-spin":""}`})})]}),t.jsx("button",{onClick:O,className:"w-full mb-3 py-2 rounded-xl bg-cyan-50 text-cyan-700 text-sm font-bold hover:bg-cyan-100",children:t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(B,{className:"w-4 h-4"}),"پروفایل جدید"]})}),t.jsxs("div",{className:"space-y-2 max-h-[60vh] overflow-auto pr-1",children:[a.map(e=>t.jsxs("button",{onClick:()=>I(e),className:`w-full text-right p-3 rounded-xl border text-sm ${c===e.id?"border-primary bg-primary/5":"border-gray-200 hover:bg-gray-50"}`,children:[t.jsx("div",{className:"font-bold",children:e.title||"بدون عنوان"}),t.jsx("div",{className:"text-xs text-gray-500 mt-1",children:K(e.module_key,e.target_table)}),e.is_active&&t.jsx("div",{className:"mt-1 text-[10px] text-green-700 bg-green-100 inline-block px-2 py-0.5 rounded",children:"فعال"})]},e.id||`${e.module_key}-${e.title}`)),!a.length&&t.jsx("div",{className:"text-xs text-gray-400 text-center py-6",children:"پروفایلی ثبت نشده است."})]})]}),t.jsxs("div",{className:"lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4 space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"عنوان پروفایل"}),t.jsx("input",{className:"w-full p-2 border rounded-xl text-sm",value:o.title,onChange:e=>i(s=>({...s,title:e.target.value}))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"ماژول هدف"}),t.jsx("select",{className:"w-full p-2 border rounded-xl text-sm",value:o.module_key,onChange:e=>i(s=>({...s,module_key:e.target.value,target_table:s.target_table||e.target.value})),children:E.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"جدول هدف (DB)"}),t.jsx("input",{className:"w-full p-2 border rounded-xl text-sm ltr text-left",value:o.target_table,onChange:e=>i(s=>({...s,target_table:e.target.value}))})]}),t.jsx("div",{className:"flex items-end",children:t.jsxs("label",{className:"inline-flex items-center gap-2 text-sm font-bold",children:[t.jsx("input",{type:"checkbox",checked:o.is_active,onChange:e=>i(s=>({...s,is_active:e.target.checked}))}),"فعال برای این ماژول"]})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"توضیحات"}),t.jsx("textarea",{className:"w-full p-2 border rounded-xl text-sm min-h-20",value:o.notes||"",onChange:e=>i(s=>({...s,notes:e.target.value}))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"تنظیمات JSON (Queryها، Mappingها و Ruleها)"}),t.jsx("textarea",{className:"w-full p-3 border rounded-xl text-xs ltr text-left font-mono min-h-[320px]",value:v,onChange:e=>m(e.target.value),spellCheck:!1})]}),t.jsxs("div",{className:"flex items-center justify-between pt-2 border-t",children:[t.jsxs("button",{onClick:$,disabled:!o.id||k,className:"px-4 py-2 rounded-xl bg-red-50 text-red-700 hover:bg-red-100 disabled:opacity-50 text-sm font-bold inline-flex items-center gap-1",children:[t.jsx(V,{className:"w-4 h-4"}),"حذف پروفایل"]}),t.jsxs("button",{onClick:J,disabled:k,className:"px-4 py-2 rounded-xl bg-primary text-white hover:bg-red-900 disabled:opacity-50 text-sm font-bold inline-flex items-center gap-1",children:[t.jsx(z,{className:"w-4 h-4"}),"ذخیره پروفایل"]})]})]})]})]})};export{Y as DataEntryToolSettings,Y as default};
