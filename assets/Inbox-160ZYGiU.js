import{r as o,j as e,ap as W,R as k,aq as I,ak as M,ao as $,P as U,l as L,ac as G,ad as K,ag as q,ai as F,C as B,ar as H,s as C,as as R,at as J,au as Q}from"./index-Ba5jVD6p.js";import{WorkOrders as z}from"./WorkOrders-DzOXS3Jr.js";import{A as _}from"./arrow-left-D4pnEk66.js";import"./paperclip-CYuFmfPe.js";const ae=({user:d})=>{var v;const[c,E]=o.useState("WORK_ORDER"),[x,m]=o.useState([]),[n,b]=o.useState(null),[f,h]=o.useState(!1),[V,p]=o.useState(null),g=async()=>{h(!0),p(null);try{const{data:a,error:t}=await C.from("cartable_items").select("*").eq("status","PENDING").order("created_at",{ascending:!1});if(t)throw t;const r=(a||[]).filter(s=>{if(s.module==="WORK_ORDER")return!0;const i=s.assignee_role===d.role,D=s.assignee_role==="INITIATOR"&&s.initiator_id===d.id,P=s.assignee_id===d.id;return i||D||P}).map(s=>({id:s.id,workflowId:s.workflow_id,trackingCode:s.tracking_code,module:s.module,title:s.title,description:s.description,currentStepId:s.current_step_id,initiatorId:s.initiator_id,assigneeRole:s.assignee_role,assigneeId:s.assignee_id,status:s.status,createdAt:new Date(s.created_at).toLocaleDateString("fa-IR"),updatedAt:new Date(s.updated_at).toLocaleDateString("fa-IR"),data:s.data||{}}));m(r)}catch(a){console.error("Error fetching inbox:",a),p("خطا در دریافت اطلاعات کارتابل.")}finally{h(!1)}};o.useEffect(()=>{g()},[d]);const u=async(a,t)=>{n&&(await Q(n.id,a,d),b(null),g())},S=async a=>{const l=y(n).find(r=>r.style==="primary"||r.style==="success");if(l&&n){const{error:r}=await C.from("cartable_items").update({data:{...n.data,...a}}).eq("id",n.id);r?alert("خطا در بروزرسانی اطلاعات."):await u(l.id)}else alert("عملیاتی برای تکمیل این مرحله یافت نشد.")},A=async a=>{var t,l;if(b(a),!((l=(t=a.data)==null?void 0:t.seen_by)!=null&&l.includes(d.id))){const r=x.map(s=>s.id===a.id?{...s,data:{...s.data,seen_by:[...s.data.seen_by||[],d.id]}}:s);m(r),await J(a.id,d.id)}},y=a=>{const l=R().find(s=>s.id===a.workflowId);if(!l)return[];const r=l.steps.find(s=>s.id===a.currentStepId);return r?r.actions:[]},O=a=>{const l=R().find(s=>s.id===a.workflowId),r=l==null?void 0:l.steps.find(s=>s.id===a.currentStepId);return(r==null?void 0:r.title)||"نامشخص"},j=a=>x.filter(t=>t.module===a).length,w=a=>x.filter(t=>{var l,r;return t.module===a&&!((r=(l=t.data)==null?void 0:l.seen_by)!=null&&r.includes(d.id))}).length,N=[{id:"WORK_ORDER",label:"دستور کارها",icon:I},{id:"PROJECT",label:"پروژه‌ها",icon:M},{id:"PERFORMANCE",label:"امتیاز عملکرد",icon:$},{id:"PART_REQUEST",label:"درخواست قطعه",icon:U},{id:"INSPECTION",label:"برنامه نت",icon:L},{id:"DOCUMENT",label:"اسناد فنی",icon:G},{id:"MEETING",label:"صورتجلسات",icon:K},{id:"SUGGESTION",label:"پیشنهادات",icon:q},{id:"PURCHASE",label:"درخواست خرید",icon:F}],T=({item:a})=>{const t=y(a),[l,r]=o.useState("");return a.module==="WORK_ORDER"?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 h-full flex flex-col overflow-hidden animate-fadeIn",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-4 border-b dark:border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"font-bold text-lg flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-primary"}),a.title]}),e.jsx("span",{className:"text-xs text-gray-500",children:a.trackingCode})]}),e.jsx("button",{onClick:()=>b(null),className:"p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full",children:e.jsx(_,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(z,{initialData:a.data,onProcessComplete:S})})]}):e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 h-full flex flex-col animate-fadeIn",children:[e.jsxs("div",{className:"p-6 border-b dark:border-gray-700 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"bg-primary/10 text-primary px-2 py-0.5 rounded text-xs font-bold",children:a.module}),e.jsx("span",{className:"text-gray-400 text-xs",children:a.trackingCode})]}),e.jsx("h2",{className:"text-xl font-bold",children:a.title}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a.description})]}),e.jsx("button",{onClick:()=>b(null),className:"p-2 hover:bg-gray-100 rounded-full",children:e.jsx(_,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-bold border-r-4 border-primary pr-3 mb-3",children:"جزئیات درخواست"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg text-sm space-y-2",children:Object.entries(a.data).map(([s,i])=>typeof i=="object"||Array.isArray(i)||s==="id"||s==="seen_by"?null:e.jsxs("div",{className:"flex justify-between border-b border-gray-200 dark:border-gray-600 pb-1 last:border-0",children:[e.jsxs("span",{className:"text-gray-500",children:[s,":"]}),e.jsx("span",{className:"font-medium",children:String(i)})]},s))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"توضیحات / دستور (اختیاری):"}),e.jsx("textarea",{value:l,onChange:s=>r(s.target.value),className:"w-full p-3 border rounded-lg dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none",placeholder:"یادداشت خود را اینجا بنویسید...",rows:3})]})]}),e.jsx("div",{className:"p-6 bg-gray-50 dark:bg-gray-900 border-t dark:border-gray-700 flex gap-3 flex-wrap",children:t.map(s=>{const i=s.style==="primary"?"bg-blue-600 hover:bg-blue-700 text-white":s.style==="success"?"bg-green-600 hover:bg-green-700 text-white":s.style==="danger"?"bg-red-600 hover:bg-red-700 text-white":"bg-gray-200 hover:bg-gray-300 text-gray-800";return e.jsx("button",{onClick:()=>u(s.id),className:`flex-1 py-3 px-4 rounded-xl font-bold shadow-md transition transform active:scale-95 ${i}`,children:s.label},s.id)})})]})};return n?e.jsx("div",{className:"max-w-7xl mx-auto h-[calc(100vh-100px)] p-4",children:e.jsx(T,{item:n})}):e.jsxs("div",{className:"max-w-7xl mx-auto h-[calc(100vh-100px)] flex flex-col md:flex-row gap-6 p-4",children:[e.jsxs("div",{className:"w-full md:w-64 flex-shrink-0 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center",children:[e.jsxs("h2",{className:"font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"})," کارتابل من"]}),e.jsx("button",{onClick:g,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",title:"بروزرسانی",children:e.jsx(k,{className:`w-4 h-4 ${f?"animate-spin":""}`})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:N.map(a=>e.jsxs("button",{onClick:()=>{E(a.id)},className:`w-full flex items-center justify-between p-3 rounded-lg text-sm transition-colors ${c===a.id?"bg-primary text-white shadow-md":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(a.icon,{className:"w-4 h-4"}),e.jsx("span",{children:a.label})]}),w(a.id)>0?e.jsx("span",{className:"bg-red-500 text-white px-2 py-0.5 rounded-full text-xs animate-pulse",children:w(a.id)}):j(a.id)>0&&e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${c===a.id?"bg-white text-primary":"bg-gray-200 text-gray-700"}`,children:j(a.id)})]},a.id))})]}),e.jsx("div",{className:"flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:e.jsxs("h3",{className:"font-bold",children:["لیست وظایف: ",(v=N.find(a=>a.id===c))==null?void 0:v.label]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:f?e.jsxs("div",{className:"text-center py-20 text-gray-400 flex flex-col items-center",children:[e.jsx(k,{className:"w-10 h-10 mb-3 animate-spin"}),e.jsx("p",{children:"در حال دریافت اطلاعات..."})]}):x.filter(a=>a.module===c).length===0?e.jsxs("div",{className:"text-center py-20 text-gray-400 flex flex-col items-center",children:[e.jsx(B,{className:"w-12 h-12 mb-3 opacity-20"}),e.jsx("p",{children:"هیچ کار فعالی در این بخش وجود ندارد."})]}):x.filter(a=>a.module===c).map(a=>{var l,r;const t=!((r=(l=a.data)==null?void 0:l.seen_by)!=null&&r.includes(d.id));return e.jsxs("div",{onClick:()=>A(a),className:`bg-white dark:bg-gray-800 p-4 rounded-xl border hover:shadow-md transition cursor-pointer group animate-slideUp relative overflow-hidden
                                        ${t?"border-l-4 border-l-red-500 border-t border-r border-b border-gray-200 shadow-sm":"border-gray-200 dark:border-gray-700"}
                                    `,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:`text-base transition ${t?"font-black text-gray-900 dark:text-white":"font-bold text-gray-700 dark:text-gray-300"}`,children:a.title}),e.jsx("p",{className:`text-sm mt-1 ${t?"font-medium text-gray-800 dark:text-gray-300":"text-gray-500"}`,children:a.description})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold",children:O(a)}),e.jsxs("div",{className:"text-xs text-gray-400 mt-2 flex items-center gap-1 justify-end",children:[e.jsx(H,{className:"w-3 h-3"})," ",a.updatedAt]})]})]}),t&&e.jsx("div",{className:"absolute top-2 left-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"})]},a.id)})})]})})]})};export{ae as Inbox,ae as default};
