import{r as l,h as $,w as K,s as q,j as e,V,Y as _,a2 as ne,R as de,P as M,X as oe,d as ie,F as ce,_ as ue,$ as me,z as S,aa as xe,ab as ge}from"./index-Ba5jVD6p.js";import{P as pe}from"./pencil-Dq-rPqXW.js";const ye=({user:E})=>{const[D,P]=l.useState([]),[N,G]=l.useState([]),[L,O]=l.useState(!1),[W,R]=l.useState("LIST"),[u,A]=l.useState([]),[J,j]=l.useState(!1),[b,z]=l.useState("ALL"),[w,U]=l.useState([]),[d,X]=l.useState([]),[T,Y]=l.useState(""),[c,v]=l.useState({description:"",workOrderCode:"",requestDate:$()}),[g,y]=l.useState([]),[a,i]=l.useState({partId:"",partName:"",qty:0,unit:"عدد"}),[m,p]=l.useState(null),[f,F]=l.useState(!1);l.useEffect(()=>{k()},[]),l.useEffect(()=>{K("parts").then(t=>U(t||[])),K("measurement_units").then(t=>X(t||[]))},[]),l.useEffect(()=>{let t=D;b!=="ALL"&&(t=t.filter(s=>s.status===b)),G(t)},[D,b]);const k=async()=>{O(!0);const{data:t}=await q.from("part_requests").select("*").order("created_at",{ascending:!1});t&&P(t),O(!1)},B=(w||[]).filter(t=>{const s=(T||"").toLowerCase();return s?(t.name||"").toLowerCase().includes(s)||(t.code||"").toLowerCase().includes(s):!0}),H=t=>{var o,r;const s=w.find(n=>n.id===t);if(s){const n=((o=d.find(x=>x.id===(s.consumption_unit_id||s.stock_unit_id)))==null?void 0:o.title)||((r=d[0])==null?void 0:r.title)||"عدد";i({partId:s.id,partName:s.name||"",partCode:s.code,qty:a.qty||1,unit:n})}else i(n=>({...n,partId:"",partName:"",partCode:""}))},Q=()=>{var o;const t=a.partId&&((o=w.find(r=>r.id===a.partId))==null?void 0:o.name)||a.partName;if(!(t!=null&&t.trim())||!a.qty||a.qty<=0||!a.unit)return;const s={partId:a.partId,partName:t.trim(),partCode:a.partCode,qty:a.qty,unit:a.unit,id:`item-${Date.now()}`};m!==null?(y(r=>r.map((n,x)=>x===m?s:n)),p(null)):y(r=>[...r,s]),i({partId:"",partName:"",qty:0,unit:d&&d[0]?d[0].title:"عدد"})},Z=t=>{const s=g[t];i({partId:s.partId,partName:s.partName,partCode:s.partCode,qty:s.qty,unit:s.unit}),p(t)},ee=t=>{y(s=>s.filter((o,r)=>r!==t)),m===t?(i({partId:"",partName:"",qty:0,unit:d&&d[0]?d[0].title:"عدد"}),p(null)):m!==null&&m>t&&p(m-1)},C=()=>{v({description:"",workOrderCode:"",requestDate:$()}),y([]),i({partId:"",partName:"",qty:0,unit:d&&d[0]?d[0].title:"عدد"}),p(null),R("LIST")},I=()=>g.length>0,te=async t=>{var s,o;if(t.preventDefault(),!(!I()||f)){F(!0);try{const n={tracking_code:await ge("PR"),requester_id:E.id,requester_name:E.fullName||"ناشناس",request_date:c.requestDate,description:((s=c.description)==null?void 0:s.trim())||null,work_order_code:((o=c.workOrderCode)==null?void 0:o.trim())||null,status:"PENDING",items:g.map(h=>({part_id:h.partId||null,part_name:h.partName,part_code:h.partCode,qty:h.qty,unit:h.unit}))},{error:x}=await q.from("part_requests").insert(n);if(x)throw x;alert("درخواست قطعه با موفقیت ثبت شد."),C(),k()}catch(r){alert("خطا: "+((r==null?void 0:r.message)||"خطا در ذخیره"))}finally{F(!1)}}},se=()=>{const t=u.length>0?N.filter(n=>u.includes(n.id)):N;if(t.length===0){alert("داده‌ای برای گزارش وجود ندارد.");return}const s=t.map(n=>({"کد پیگیری":n.tracking_code,"درخواست کننده":n.requester_name,"تاریخ درخواست":n.request_date,وضعیت:n.status,توضیحات:n.description})),o=S.json_to_sheet(s),r=S.book_new();S.book_append_sheet(r,o,"PartRequests"),xe(r,`part_requests_${Date.now()}.xlsx`)},ae=async()=>{await q.from("part_requests").delete().in("id",u),P(t=>t.filter(s=>!u.includes(s.id))),A([]),j(!1)},re=e.jsxs(e.Fragment,{children:[u.length>0&&e.jsx("button",{onClick:()=>j(!0),className:"p-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition",title:"حذف",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>R("NEW"),className:"p-2.5 bg-cyan-50 text-cyan-600 rounded-xl hover:bg-cyan-100 transition",title:"درخواست جدید",children:e.jsx(_,{className:"w-5 h-5"})}),e.jsx("button",{onClick:se,className:"p-2.5 bg-green-50 text-green-600 rounded-xl hover:bg-green-100 transition",title:"خروجی اکسل",children:e.jsx(ne,{className:"w-5 h-5"})}),e.jsx("button",{onClick:k,className:"p-2.5 bg-gray-50 text-gray-600 rounded-xl hover:bg-gray-100 transition",title:"بروزرسانی",children:e.jsx(de,{className:`w-5 h-5 ${L?"animate-spin":""}`})})]}),le=e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:b,onChange:t=>z(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"PENDING",children:"در حال بررسی"}),e.jsx("option",{value:"APPROVED",children:"تایید شده"}),e.jsx("option",{value:"REJECTED",children:"رد شده"})]})]})});return W==="NEW"?e.jsxs("div",{className:"max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white",children:[e.jsx(M,{className:"w-6 h-6 text-primary"})," درخواست کالا"]}),e.jsx("button",{onClick:C,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(oe,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:te,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"font-bold text-gray-700 dark:text-gray-200 border-b dark:border-gray-600 pb-2 mb-4",children:"اطلاعات درخواست"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"توضیحات"}),e.jsx("input",{type:"text",value:c.description,onChange:t=>v({...c,description:t.target.value}),className:"w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",placeholder:"شرح درخواست..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"تاریخ درخواست"}),e.jsx("input",{type:"text",value:c.requestDate,readOnly:!0,className:"w-full p-2.5 border rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"کد دستور کار"}),e.jsx("input",{type:"text",value:c.workOrderCode,onChange:t=>v({...c,workOrderCode:t.target.value}),className:"w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",placeholder:"WO-0001..."})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"font-bold text-gray-700 dark:text-gray-200 border-b dark:border-gray-600 pb-2 mb-4 flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-green-600"}),m!==null?"ویرایش قلم کالا":"افزودن قلم کالا"]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:["انتخاب قطعه ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:T,onChange:t=>Y(t.target.value),placeholder:"جستجو در لیست قطعات...",className:"w-full p-2 mb-2 border rounded-lg text-sm"}),e.jsxs("select",{value:a.partId,onChange:t=>H(t.target.value),className:"w-full p-3 border rounded-xl bg-white dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",children:[e.jsx("option",{value:"",children:"-- قطعه را انتخاب کنید --"}),B.slice(0,100).map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.code?`(${t.code})`:""]},t.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-4 items-end",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نام قطعه (اگر در لیست نبود)"}),e.jsx("input",{type:"text",value:a.partName,onChange:t=>i({...a,partName:t.target.value}),className:"w-full p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-primary",placeholder:"نام قطعه..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:["تعداد ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",min:.01,step:.01,value:a.qty||"",onChange:t=>i({...a,qty:Number(t.target.value)}),className:"w-full p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-primary text-center font-bold"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:["واحد ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{value:a.unit||"عدد",onChange:t=>i({...a,unit:t.target.value}),className:"w-full p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-primary",children:(d&&d.length>0?d:[{id:"1",title:"عدد"}]).map(t=>e.jsx("option",{value:t.title,children:t.title},t.id))})]})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("button",{type:"button",onClick:Q,className:"w-full sm:w-auto px-6 py-2.5 bg-green-600 text-white rounded-xl hover:bg-green-700 shadow-lg flex items-center justify-center gap-2 font-bold transition",children:[e.jsx(_,{className:"w-5 h-5"})," افزودن به لیست"]})})]}),g.length>0&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"font-bold text-gray-700 dark:text-gray-200 border-b dark:border-gray-600 pb-2 mb-4",children:"لیست اقلام درخواستی"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b dark:border-gray-600 text-right",children:[e.jsx("th",{className:"py-2 px-2",children:"ردیف"}),e.jsx("th",{className:"py-2 px-2",children:"نام قطعه"}),e.jsx("th",{className:"py-2 px-2",children:"تعداد"}),e.jsx("th",{className:"py-2 px-2",children:"واحد"}),e.jsx("th",{className:"py-2 px-2 w-20",children:"عملیات"})]})}),e.jsx("tbody",{children:g.map((t,s)=>e.jsxs("tr",{className:"border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"py-2 px-2",children:s+1}),e.jsx("td",{className:"py-2 px-2",children:t.partName}),e.jsx("td",{className:"py-2 px-2 font-bold",children:t.qty}),e.jsx("td",{className:"py-2 px-2",children:t.unit}),e.jsxs("td",{className:"py-2 px-2 flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>Z(s),className:"p-1.5 text-blue-600 hover:bg-blue-50 rounded",children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>ee(s),className:"p-1.5 text-red-600 hover:bg-red-50 rounded",children:e.jsx(V,{className:"w-4 h-4"})})]})]},t.id||s))})]})})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:C,className:"flex-1 border py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700",children:"انصراف"}),e.jsxs("button",{type:"submit",disabled:!I()||f,className:`flex-[2] py-3 rounded-xl shadow flex justify-center gap-2 font-bold transition ${I()&&!f?"bg-primary text-white hover:bg-red-800":"bg-gray-400 text-gray-500 cursor-not-allowed"}`,children:[f?e.jsx(ie,{className:"w-5 h-5 animate-spin"}):e.jsx(ce,{className:"w-5 h-5"})," ثبت درخواست"]})]})]})]}):e.jsxs("div",{className:"max-w-7xl mx-auto pb-20 space-y-6",children:[e.jsx(ue,{isOpen:J,onClose:()=>j(!1),onConfirm:ae,title:"حذف درخواست",message:`آیا از حذف ${u.length} مورد انتخاب شده اطمینان دارید؟`}),e.jsx(me,{title:"لیست درخواست قطعه",icon:M,data:N,isLoading:L,extraActions:re,selectedIds:u,onSelect:A,filterContent:le,columns:[{header:"کد پیگیری",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code}),sortKey:"tracking_code"},{header:"درخواست کننده",accessor:t=>t.requester_name,sortKey:"requester_name"},{header:"تاریخ",accessor:t=>t.request_date,sortKey:"request_date"},{header:"وضعیت",accessor:t=>e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${t.status==="APPROVED"?"bg-green-100 text-green-700":t.status==="REJECTED"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:t.status==="PENDING"?"در حال بررسی":t.status==="APPROVED"?"تایید شده":"رد شده"}),sortKey:"status"},{header:"توضیحات",accessor:t=>t.description||"-",sortKey:"description"},{header:"اقلام",accessor:t=>Array.isArray(t.items)?t.items.length+" قلم":"-",sortKey:"items"}]})]})};export{ye as PartRequests,ye as default};
