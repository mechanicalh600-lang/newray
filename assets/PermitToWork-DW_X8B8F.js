import{r,w as W,s as b,j as e,a4 as H,S as m,X as z,ae as f,bJ as j,al as K,ab as F,A as G,ad as M}from"./index-Ba5jVD6p.js";const J=({user:v})=>{const[u,x]=r.useState([]),[y,g]=r.useState([]),[N,h]=r.useState(!1),[k,i]=r.useState(!1),[w,T]=r.useState([]),[C,L]=r.useState([]),[d,_]=r.useState("ALL"),[o,O]=r.useState("ALL"),[a,n]=r.useState({type:"HOT_WORK",equipmentId:"",hazards:[],precautions:[],startTime:"",endTime:""}),S=["گازهای قابل اشتعال","خطر برق‌گرفتگی","سقوط از ارتفاع","کمبود اکسیژن","مواد شیمیایی"],P=["ایزولاسیون الکتریکی","تهویه مناسب","استفاده از کمربند ایمنی","حضور نفر کمکی","کپسول آتش‌نشانی"],p=(t,s,l)=>{l(t.includes(s)?t.filter(D=>D!==s):[...t,s])};r.useEffect(()=>{c(),W("equipment").then(T)},[]),r.useEffect(()=>{let t=u;d!=="ALL"&&(t=t.filter(s=>s.permit_type===d)),o!=="ALL"&&(t=t.filter(s=>s.status===o)),g(t)},[u,d,o]);const c=async()=>{h(!0);const{data:t}=await b.from("work_permits").select("*, equipment(name)").order("created_at",{ascending:!1});t&&(x(t),g(t)),h(!1)},I=async t=>{alert("حذف مجوز (شبیه‌سازی)"),x(s=>s.filter(l=>!t.includes(l.id)))},A=async t=>{t.preventDefault();try{const s=await F("PTW");await b.from("work_permits").insert({tracking_code:s,permit_type:a.type,equipment_id:a.equipmentId,hazards:a.hazards,precautions:a.precautions,start_time:a.startTime,end_time:a.endTime,requester_id:v.id,status:"PENDING"}),i(!1),n({type:"HOT_WORK",equipmentId:"",hazards:[],precautions:[],startTime:"",endTime:""}),c(),alert(`مجوز کار با شماره ${s} صادر شد.`)}catch(s){alert("خطا: "+((s==null?void 0:s.message)||"خطا در صدور مجوز"))}},E=t=>{switch(t){case"HOT_WORK":return{label:"کار گرم",color:"text-red-600 bg-red-50 border-red-100",icon:j};case"COLD_WORK":return{label:"کار سرد",color:"text-blue-600 bg-blue-50 border-blue-100",icon:M};case"HEIGHT":return{label:"کار در ارتفاع",color:"text-orange-600 bg-orange-50 border-orange-100",icon:G};default:return{label:t,color:"text-gray-600 bg-gray-50 border-gray-200",icon:m}}},R=[{header:"شماره مجوز",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code})},{header:"نوع مجوز",accessor:t=>{const s=E(t.permit_type),l=s.icon;return e.jsxs("span",{className:`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold w-fit border ${s.color}`,children:[e.jsx(l,{className:"w-3 h-3"})," ",s.label]})}},{header:"تجهیز",accessor:t=>{var s;return((s=t.equipment)==null?void 0:s.name)||"---"}},{header:"زمان شروع",accessor:t=>t.start_time},{header:"زمان پایان",accessor:t=>t.end_time},{header:"وضعیت",accessor:t=>t.status}],q=e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع مجوز"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:d,onChange:t=>_(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"HOT_WORK",children:"کار گرم"}),e.jsx("option",{value:"COLD_WORK",children:"کار سرد"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:o,onChange:t=>O(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"PENDING",children:"در انتظار"}),e.jsx("option",{value:"APPROVED",children:"تایید شده"})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(H,{title:"مجوزهای کار (PTW)",icon:m,data:y,isLoading:N,columns:R,onAdd:()=>i(!0),onReload:c,onDelete:I,selectedIds:C,onSelect:L,filterContent:q,exportName:"Permits"}),k&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:e.jsxs("form",{onSubmit:A,className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl p-6 space-y-6 max-h-[90vh] overflow-y-auto animate-scaleIn",children:[e.jsxs("div",{className:"flex justify-between items-center border-b dark:border-gray-700 pb-4",children:[e.jsxs("h3",{className:"font-bold text-lg flex items-center gap-2 text-gray-800 dark:text-white",children:[e.jsx(m,{className:"w-6 h-6 text-green-600"})," صدور پرمیت جدید"]}),e.jsx("button",{type:"button",onClick:()=>i(!1),className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(z,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"نوع مجوز"}),e.jsxs("select",{className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:a.type,onChange:t=>n({...a,type:t.target.value}),children:[e.jsx("option",{value:"HOT_WORK",children:"کار گرم (برشکاری/جوشکاری)"}),e.jsx("option",{value:"COLD_WORK",children:"کار سرد (تعمیرات عمومی)"}),e.jsx("option",{value:"HEIGHT",children:"کار در ارتفاع"}),e.jsx("option",{value:"CONFINED_SPACE",children:"فضای بسته"}),e.jsx("option",{value:"ELECTRICAL",children:"کار روی برق (ایزولاسیون)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"تجهیز / محل کار"}),e.jsxs("select",{className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:a.equipmentId,onChange:t=>n({...a,equipmentId:t.target.value}),children:[e.jsx("option",{value:"",children:"انتخاب تجهیز..."}),w.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx("div",{children:e.jsx(f,{label:"ساعت شروع",value:a.startTime,onChange:t=>n({...a,startTime:t})})}),e.jsx("div",{children:e.jsx(f,{label:"ساعت پایان",value:a.endTime,onChange:t=>n({...a,endTime:t})})})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/10 p-4 rounded-xl border border-red-100 dark:border-red-900",children:[e.jsxs("h4",{className:"font-bold text-red-700 dark:text-red-400 mb-3 text-sm flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4"})," خطرات شناسایی شده"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:S.map(t=>e.jsxs("label",{className:"flex items-center gap-2 text-xs font-medium cursor-pointer hover:bg-white/50 dark:hover:bg-white/10 p-2 rounded transition",children:[e.jsx("input",{type:"checkbox",className:"accent-red-600 w-4 h-4",checked:a.hazards.includes(t),onChange:()=>p(a.hazards,t,s=>n({...a,hazards:s}))}),t]},t))})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/10 p-4 rounded-xl border border-green-100 dark:border-green-900",children:[e.jsxs("h4",{className:"font-bold text-green-700 dark:text-green-400 mb-3 text-sm flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"})," اقدامات احتیاطی الزامی"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:P.map(t=>e.jsxs("label",{className:"flex items-center gap-2 text-xs font-medium cursor-pointer hover:bg-white/50 dark:hover:bg-white/10 p-2 rounded transition",children:[e.jsx("input",{type:"checkbox",className:"accent-green-600 w-4 h-4",checked:a.precautions.includes(t),onChange:()=>p(a.precautions,t,s=>n({...a,precautions:s}))}),t]},t))})]}),e.jsxs("div",{className:"pt-4 border-t dark:border-gray-700 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>i(!1),className:"px-6 py-2.5 border rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition",children:"انصراف"}),e.jsx("button",{type:"submit",className:"px-6 py-2.5 bg-primary text-white rounded-xl shadow hover:bg-red-800 transition",children:"صدور مجوز"})]})]})})]})};export{J as PermitToWork,J as default};
