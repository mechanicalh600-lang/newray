import{c as me,r as o,w as be,s as O,j as e,V as G,Y as R,a2 as pe,R as he,ak as U,a6 as Z,al as fe,X as ye,d as je,F as Ne,_ as ve,$ as we,z as V,aa as ke,ab as Se,am as Ie,an as Ce}from"./index-Ba5jVD6p.js";import{P as De}from"./pencil-Dq-rPqXW.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=me("GanttChart",[["path",{d:"M8 6h10",key:"9lnwnk"}],["path",{d:"M6 12h9",key:"1g9pqf"}],["path",{d:"M11 18h7",key:"c8dzvl"}]]),M=()=>Math.random().toString(36).slice(2,11);function ee(l){const x=new Map(l.map(a=>[a.id,{...a,children:[]}])),h=[];for(const a of l){const n=x.get(a.id);if(!a.parentId)h.push(n);else{const c=x.get(a.parentId);c?c.children.push(n):h.push(n)}}h.sort((a,n)=>a.order-n.order);for(const a of h)a.children.sort((n,c)=>n.order-c.order);let u=1;const y=a=>{var n;for(const c of a)c.rowNo=u++,(n=c.children)!=null&&n.length&&y(c.children)};return y(h),h}function T(l,x){const u=l.filter(n=>n.parentId===x.parentId).sort((n,c)=>n.order-c.order).findIndex(n=>n.id===x.id)+1;if(!x.parentId)return String(u);const y=l.find(n=>n.id===x.parentId);return y?`${T(l,y)}.${u}`:String(u)}function te({node:l,rowNo:x,siblings:h,onAddChild:u,onDelete:y,onPercentChange:a,level:n}){var k;const[c,I]=o.useState(!0),p=((k=l.children)==null?void 0:k.length)>0,C=l.percent!=null&&l.percent!==""?Math.min(100,Math.max(1,Number(l.percent))):void 0,K=C??"",D=f=>{if(f===""||f===void 0)a==null||a(l.id,void 0);else{const _=Number(f);isNaN(_)||a==null||a(l.id,Math.min(100,Math.max(1,_)))}};return e.jsxs("div",{className:"rounded",style:{marginRight:n*16},children:[e.jsxs("div",{className:"flex items-center gap-2 py-1.5 px-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded group",children:[e.jsx("span",{className:"text-xs font-bold text-gray-500 w-5 text-center",children:x}),e.jsx("button",{type:"button",onClick:()=>I(!c),className:"p-0.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",children:p?c?e.jsx(Ie,{className:"w-4 h-4"}):e.jsx(Ce,{className:"w-4 h-4"}):e.jsx("span",{className:"w-4 h-4 inline-block"})}),e.jsx("span",{className:"text-sm flex-1 truncate",children:l.title}),e.jsxs("div",{className:"flex items-center gap-1 min-w-[4rem]",children:[e.jsx("input",{type:"number",min:1,max:100,value:K,onChange:f=>D(f.target.value),placeholder:"—",className:"w-14 px-1.5 py-0.5 text-xs text-center border rounded dark:bg-gray-700 focus:ring-1 focus:ring-primary",dir:"ltr"}),e.jsx("span",{className:"text-xs text-gray-500",children:"%"})]}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 flex gap-1 transition",children:[e.jsx("button",{type:"button",onClick:()=>u(l.id),className:"p-1 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded",title:"افزودن زیرفعالیت",children:e.jsx(R,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>y(l.id),className:"p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded",title:"حذف",children:e.jsx(G,{className:"w-4 h-4"})})]})]}),c&&p&&e.jsx("div",{className:"mr-2 border-r-2 border-gray-200 dark:border-gray-600",children:l.children.map(f=>e.jsx(te,{node:f,rowNo:f.rowNo??0,siblings:l.children,onAddChild:u,onDelete:y,onPercentChange:a,level:n+1},f.id))})]})}const Me=({user:l})=>{const[x,h]=o.useState([]),[u,y]=o.useState([]),[a,n]=o.useState(!1),[c,I]=o.useState("LIST"),[p,C]=o.useState([]),[K,D]=o.useState(!1),[k,f]=o.useState("ALL"),[_,se]=o.useState([]),[d,j]=o.useState({title:"",managerId:"",startDate:"",endDate:"",budget:"",description:""}),[$,E]=o.useState([]),[v,S]=o.useState([]),[W,z]=o.useState(""),[A,H]=o.useState(""),[F,J]=o.useState(!1),[w,P]=o.useState(null);o.useEffect(()=>{q(),be("personnel").then(se)},[]),o.useEffect(()=>{let t=x;k!=="ALL"&&(t=t.filter(s=>s.status===k)),y(t)},[x,k]);const q=async()=>{n(!0);const{data:t}=await O.from("projects").select("*").order("created_at",{ascending:!1});t&&h(t),n(!1)},re=async()=>{await O.from("projects").delete().in("id",p),h(t=>t.filter(s=>!p.includes(s.id))),C([]),D(!1)},ae=t=>j({...d,managerId:t.target.value}),X=()=>{W.trim()&&(E(t=>[...t,{id:M(),text:W.trim()}]),z(""))},ne=t=>E(s=>s.filter(g=>g.id!==t)),Y=()=>{if(!A.trim())return;const t=M(),s=v.filter(r=>!r.parentId).length,g=s+1;S(r=>{let m=[...r,{id:t,code:"",title:A.trim(),parentId:null,order:s,percent:g===1?void 0:1}];return m.map(b=>({...b,code:T(m,b)}))}),H("")},de=t=>{const s=prompt("عنوان زیرکار را وارد کنید:");if(!(s!=null&&s.trim()))return;const r=v.filter(b=>b.parentId===t).length,m=r+1;S(b=>{let N=[...b,{id:M(),code:"",title:s.trim(),parentId:t,order:r,percent:m===1?void 0:1}];return N.map(L=>({...L,code:T(N,L)}))})},le=t=>{const s=new Set,g=r=>{s.add(r),v.filter(m=>m.parentId===r).forEach(m=>g(m.id))};g(t),S(r=>{const m=r.filter(b=>!s.has(b.id));return m.map(b=>({...b,code:T(m,b)}))})},Q=()=>{I("LIST"),P(null),j({title:"",managerId:"",startDate:"",endDate:"",budget:"",description:""}),E([]),S([])},B=()=>{var t;return!!((t=d.title)!=null&&t.trim())&&!!d.managerId&&$.length>0},oe=async t=>{var s,g;if(t.preventDefault(),!(!B()||F)){J(!0);try{const r=_.find(i=>i.id===d.managerId),m=w?((s=x.find(i=>i.id===w))==null?void 0:s.tracking_code)||"":await Se("PROJ"),b=d.budget?Number(d.budget.replace(/,/g,"")):null,N=w?x.find(i=>i.id===w):null,L={title:d.title.trim(),manager_id:d.managerId,manager_name:(r==null?void 0:r.full_name)||"",start_date:d.startDate||null,end_date:d.endDate||null,budget:b,description:((g=d.description)==null?void 0:g.trim())||null,objectives:$.map(i=>({id:i.id,text:i.text})),wbs:v.map(i=>({id:i.id,code:i.code,title:i.title,parentId:i.parentId,order:i.order,percent:i.percent!=null&&i.percent!==""?i.percent:void 0})),status:(N==null?void 0:N.status)||"PLANNED",progress:(N==null?void 0:N.progress)??0};w?(await O.from("projects").update(L).eq("id",w),alert("پروژه با موفقیت ویرایش شد.")):(await O.from("projects").insert([{...L,tracking_code:m}]),alert("پروژه با موفقیت ایجاد شد.")),Q(),q()}catch(r){alert("خطا: "+((r==null?void 0:r.message)||"خطا در ذخیره"))}finally{J(!1)}}},ie=()=>{const t=p.length>0?u.filter(r=>p.includes(r.id)):u,s=V.json_to_sheet(t),g=V.book_new();V.book_append_sheet(g,s,"Projects"),ke(g,`projects_${Date.now()}.xlsx`)},ce=(t,s)=>S(g=>g.map(r=>r.id===t?{...r,percent:s}:r)),ge=t=>{P(t.id),j({title:t.title||"",managerId:t.manager_id||"",startDate:t.start_date||"",endDate:t.end_date||"",budget:t.budget?String(t.budget).replace(/\B(?=(\d{3})+(?!\d))/g,","):"",description:t.description||""}),E(Array.isArray(t.objectives)?t.objectives.map(s=>({id:s.id||M(),text:s.text||""})):[]),S(Array.isArray(t.wbs)?t.wbs.map(s=>({id:s.id||M(),code:s.code||"",title:s.title||"",parentId:s.parentId??null,order:s.order??0,percent:s.percent!=null&&s.percent!==""?s.percent:void 0})):[]),I("NEW")},xe=e.jsxs(e.Fragment,{children:[p.length===1&&e.jsx("button",{onClick:()=>{const t=u.find(s=>s.id===p[0]);t&&ge(t)},className:"p-2.5 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100 transition",title:"ویرایش",children:e.jsx(De,{className:"w-5 h-5"})}),p.length>0&&e.jsx("button",{onClick:()=>D(!0),className:"p-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition",title:"حذف",children:e.jsx(G,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>{P(null),j({title:"",managerId:"",startDate:"",endDate:"",budget:"",description:""}),E([]),S([]),I("NEW")},className:"p-2.5 bg-cyan-50 text-cyan-600 rounded-xl hover:bg-cyan-100 transition",title:"پروژه جدید",children:e.jsx(R,{className:"w-5 h-5"})}),e.jsx("button",{onClick:ie,className:"p-2.5 bg-green-50 text-green-600 rounded-xl hover:bg-green-100 transition",title:"خروجی اکسل",children:e.jsx(pe,{className:"w-5 h-5"})}),e.jsx("button",{onClick:q,className:"p-2.5 bg-gray-50 text-gray-600 rounded-xl hover:bg-gray-100 transition",title:"بروزرسانی",children:e.jsx(he,{className:`w-5 h-5 ${a?"animate-spin":""}`})})]}),ue=e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت پروژه"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:k,onChange:t=>f(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"PLANNED",children:"برنامه‌ریزی شده"}),e.jsx("option",{value:"IN_PROGRESS",children:"در حال اجرا"}),e.jsx("option",{value:"COMPLETED",children:"تکمیل شده"}),e.jsx("option",{value:"HALTED",children:"متوقف شده"})]})]})});return c==="NEW"?e.jsxs("div",{className:"max-w-4xl mx-auto pb-20 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[e.jsx(U,{className:"w-6 h-6 text-primary"}),e.jsx("h1",{className:"text-2xl font-bold",children:w?"ویرایش پروژه":"تعریف پروژه جدید"})]}),e.jsxs("form",{onSubmit:oe,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm space-y-6 border border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:["عنوان پروژه ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{value:d.title,onChange:t=>j({...d,title:t.target.value}),required:!0,className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",placeholder:"نام پروژه..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:["مدیر پروژه ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.managerId,onChange:ae,required:!0,className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",children:[e.jsx("option",{value:"",children:"انتخاب کنید..."}),_.map(t=>e.jsxs("option",{value:t.id,children:[t.full_name," (",t.unit||"-",")"]},t.id))]})]}),e.jsx("div",{children:e.jsx(Z,{label:"تاریخ شروع",value:d.startDate||"",onChange:t=>j({...d,startDate:t}),disableFuture:!1})}),e.jsx("div",{children:e.jsx(Z,{label:"تاریخ پایان (تخمین)",value:d.endDate||"",onChange:t=>j({...d,endDate:t}),disableFuture:!1})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"بودجه مصوب (ریال)"}),e.jsx("input",{type:"text",inputMode:"numeric",dir:"ltr",value:d.budget,onChange:t=>{const s=t.target.value.replace(/,/g,"");/^\d*$/.test(s)&&j({...d,budget:s.replace(/\B(?=(\d{3})+(?!\d))/g,",")})},className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary text-left",placeholder:"اختیاری..."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"توضیحات تکمیلی"}),e.jsx("textarea",{value:d.description,onChange:t=>j({...d,description:t.target.value}),className:"w-full p-3 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary min-h-[100px]",placeholder:"توضیحات پروژه..."})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-bold text-gray-700 dark:text-gray-200 mb-2 flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5"})," اهداف و محدوده پروژه ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:W,onChange:t=>z(t.target.value),placeholder:"هدف یا محدوده پروژه را وارد کنید...",className:"flex-1 p-2.5 border rounded-lg dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",onKeyDown:t=>t.key==="Enter"&&(t.preventDefault(),X())}),e.jsx("button",{type:"button",onClick:X,disabled:!W.trim(),className:"bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(R,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:$.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full",children:s+1}),e.jsx("span",{className:"text-sm",children:t.text})]}),e.jsx("button",{type:"button",onClick:()=>ne(t.id),className:"text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded",children:e.jsx(G,{className:"w-4 h-4"})})]},t.id))})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-bold text-gray-700 dark:text-gray-200 mb-3 flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5 text-primary"})," ساختار شکست کار (WBS)"]}),e.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"فعالیت‌ها و خروجی‌های پروژه را به صورت سلسله‌مراتبی تعریف کنید."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:A,onChange:t=>H(t.target.value),placeholder:"عنوان فعالیت/خروجی (سطح اول)...",className:"flex-1 p-2.5 border rounded-lg dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",onKeyDown:t=>t.key==="Enter"&&(t.preventDefault(),Y())}),e.jsx("button",{type:"button",onClick:Y,disabled:!A.trim(),className:"bg-primary text-white px-4 rounded-lg hover:bg-red-800 transition disabled:opacity-50 disabled:cursor-not-allowed",title:"افزودن",children:e.jsx(R,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-1 max-h-64 overflow-y-auto rounded-lg border border-gray-200 dark:border-gray-600 p-2 bg-white dark:bg-gray-800",children:[v.length>0&&e.jsxs("div",{className:"flex items-center gap-2 py-1.5 px-2 text-xs font-bold text-gray-500 border-b border-gray-200 dark:border-gray-600 mb-1",children:[e.jsx("span",{className:"w-5 text-center",children:"ردیف"}),e.jsx("span",{className:"w-6"}),e.jsx("span",{className:"flex-1",children:"عنوان"}),e.jsx("span",{className:"min-w-[4rem] text-center",children:"درصد"}),e.jsx("span",{className:"w-16"})]}),ee(v).map(t=>e.jsx(te,{node:t,rowNo:t.rowNo??0,siblings:ee(v),onAddChild:de,onDelete:le,onPercentChange:ce,level:0},t.id)),v.length===0&&e.jsx("p",{className:"text-gray-400 text-sm py-4 text-center",children:"هنوز فعالیتی اضافه نشده. یک فعالیت سطح اول اضافه کنید."})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsxs("button",{type:"button",onClick:Q,className:"flex-1 border border-gray-300 dark:border-gray-600 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center gap-2 transition",children:[e.jsx(ye,{className:"w-5 h-5"})," انصراف"]}),e.jsxs("button",{type:"submit",disabled:!B()||F,className:`flex-[2] text-white py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition font-bold ${B()&&!F?"bg-primary hover:bg-red-800":"bg-gray-400 cursor-not-allowed opacity-70"}`,children:[F?e.jsx(je,{className:"w-5 h-5 animate-spin"}):e.jsx(Ne,{className:"w-5 h-5"}),w?"ویرایش پروژه":"ایجاد پروژه و شروع گردش کار"]})]})]})]}):e.jsxs("div",{className:"max-w-7xl mx-auto pb-20 space-y-6",children:[e.jsx(ve,{isOpen:K,onClose:()=>D(!1),onConfirm:re,title:"حذف پروژه",message:`آیا از حذف ${p.length} پروژه انتخاب شده اطمینان دارید؟`}),e.jsx(we,{title:"مدیریت پروژه‌ها",icon:U,data:u,isLoading:a,extraActions:xe,selectedIds:p,onSelect:C,filterContent:ue,columns:[{header:"کد پروژه",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code}),sortKey:"tracking_code"},{header:"عنوان پروژه",accessor:t=>t.title,sortKey:"title"},{header:"مدیر پروژه",accessor:t=>t.manager_name,sortKey:"manager_name"},{header:"شروع",accessor:t=>t.start_date,sortKey:"start_date"},{header:"پایان",accessor:t=>t.end_date,sortKey:"end_date"},{header:"پیشرفت",accessor:t=>`${t.progress}%`,sortKey:"progress"},{header:"WBS",accessor:t=>Array.isArray(t.wbs)&&t.wbs.length?e.jsx("span",{className:"text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded",children:t.wbs.length}):"-",sortKey:void 0},{header:"وضعیت",accessor:t=>t.status,sortKey:"status"}]})]})};export{Me as Projects,Me as default};
