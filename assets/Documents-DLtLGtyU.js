import{r as o,s as i,j as e,E as q,Q as B,ac as j,X as H,I as z,d as J,a4 as V}from"./index-Ba5jVD6p.js";const L="technical-documents",S=10,X=()=>{const[p,N]=o.useState([]),[C,v]=o.useState(!1),[_,d]=o.useState("LIST"),[u,w]=o.useState(!1),[b,k]=o.useState([]),[f,D]=o.useState("ALL"),[c,A]=o.useState(null),g=o.useRef(null),[r,x]=o.useState({code:"",name:"",type:""});o.useEffect(()=>{m()},[]);const m=async()=>{v(!0);const{data:t}=await i.from("technical_documents").select("*").order("created_at",{ascending:!1});t&&N(t),v(!1)},T=async t=>{try{const{error:a}=await i.from("technical_documents").delete().in("id",t);if(a)throw a;N(s=>s.filter(l=>!t.includes(l.id))),k([])}catch(a){alert("خطا در حذف: "+((a==null?void 0:a.message)||a))}},I=()=>{var t;return(t=g.current)==null?void 0:t.click()},P=t=>{var s;const a=(s=t.target.files)==null?void 0:s[0];if(a){if(a.size>S*1024*1024){alert(`حداکثر حجم فایل ${S} مگابایت است.`);return}const l=(a.name.split(".").pop()||"").toLowerCase();if(!["pdf","jpg","jpeg","png"].includes(l)){alert("فرمت مجاز: PDF, JPG, PNG");return}A(a)}},h=()=>{x({code:"",name:"",type:""}),A(null),g.current&&(g.current.value="")},y=()=>{var t,a;return!!((t=r.code)!=null&&t.trim())&&!!((a=r.name)!=null&&a.trim())&&!!r.type&&!!c},E=async t=>{if(t.preventDefault(),!y()||u)return;w(!0);let a=null;try{if(c){const l=`${Date.now()}_${c.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,{data:n,error:K}=await i.storage.from(L).upload(l,c,{upsert:!1});if(!K&&(n!=null&&n.path)){const{data:$}=i.storage.from(L).getPublicUrl(n.path);a=$.publicUrl}}const{error:s}=await i.from("technical_documents").insert({code:r.code.trim(),title:r.name.trim(),type:r.type,file_url:a});if(s)throw s;alert("سند با موفقیت به بایگانی اضافه شد."),h(),d("LIST"),m()}catch(s){const l=(s==null?void 0:s.message)||"";if(l.includes("Bucket not found")||l.includes("bucket")||l.includes("Storage")){const{error:n}=await i.from("technical_documents").insert({code:r.code.trim(),title:r.name.trim(),type:r.type,file_url:null});if(n){alert("خطا: "+((n==null?void 0:n.message)||n));return}alert("سند ثبت شد. برای آپلود فایل، باکت technical-documents را در Supabase Storage بسازید."),h(),d("LIST"),m()}else alert("خطا: "+l)}finally{w(!1)}},M=e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع سند"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:f,onChange:t=>D(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"MAP",children:"نقشه فنی"}),e.jsx("option",{value:"CATALOG",children:"کاتالوگ و دیتاشیت"}),e.jsx("option",{value:"MANUAL",children:"دستورالعمل تعمیراتی"}),e.jsx("option",{value:"OTHER",children:"سایر اسناد"})]})]})}),F=f==="ALL"?p:p.filter(t=>t.type===f),R=p.find(t=>b.includes(t.id)),U=b.length===1&&R?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>alert("مشاهده"),className:"p-2.5 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100 transition",title:"مشاهده",children:e.jsx(q,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>alert("ویرایش"),className:"p-2.5 bg-orange-50 text-orange-600 rounded-xl hover:bg-orange-100 transition",title:"ویرایش",children:e.jsx(B,{className:"w-5 h-5"})})]}):null,G=t=>({MAP:"نقشه فنی",CATALOG:"کاتالوگ و دیتاشیت",MANUAL:"دستورالعمل تعمیراتی",OTHER:"سایر اسناد"})[t]||t;if(_==="NEW")return e.jsxs("div",{className:"max-w-2xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white",children:[e.jsx(j,{className:"w-6 h-6 text-primary"})," ثبت سند فنی"]}),e.jsx("button",{onClick:()=>{h(),d("LIST")},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(H,{className:"w-5 h-5"})})]}),e.jsx("form",{onSubmit:E,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm h-fit border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1 font-bold text-gray-700 dark:text-gray-300",children:["کد بایگانی ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{value:r.code,onChange:t=>x({...r,code:t.target.value}),required:!0,className:"w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary transition-all",placeholder:"مثال: MAP-101"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1 font-bold text-gray-700 dark:text-gray-300",children:["عنوان سند ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{value:r.name,onChange:t=>x({...r,name:t.target.value}),required:!0,className:"w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary transition-all",placeholder:"عنوان نقشه یا کاتالوگ..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1 font-bold text-gray-700 dark:text-gray-300",children:["نوع سند ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:r.type,onChange:t=>x({...r,type:t.target.value}),required:!0,className:"w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary transition-all cursor-pointer",children:[e.jsx("option",{value:"",children:"انتخاب کنید..."}),e.jsx("option",{value:"MAP",children:"نقشه فنی"}),e.jsx("option",{value:"CATALOG",children:"کاتالوگ و دیتاشیت"}),e.jsx("option",{value:"MANUAL",children:"دستورالعمل تعمیراتی"}),e.jsx("option",{value:"OTHER",children:"سایر اسناد"})]})]}),e.jsx("input",{type:"file",ref:g,onChange:P,className:"hidden",accept:".pdf,.jpg,.jpeg,.png"}),e.jsxs("div",{onClick:I,className:`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all mt-6 ${c?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[e.jsx(z,{className:`w-10 h-10 mx-auto mb-4 ${c?"text-green-600":"text-gray-400"}`}),e.jsx("span",{className:"text-sm font-bold text-gray-600 dark:text-gray-300 block",children:c?c.name:"برای آپلود فایل کلیک کنید"}),e.jsx("span",{className:"text-xs text-gray-400 mt-2 block",children:"PDF, JPG, PNG (Max 10MB)"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t dark:border-gray-700 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>{h(),d("LIST")},className:"flex-1 border py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition",children:"انصراف"}),e.jsxs("button",{type:"submit",disabled:!y()||u,className:`flex-[2] py-3 rounded-xl shadow-lg font-bold transition-all flex items-center justify-center gap-2 ${y()&&!u?"bg-primary text-white hover:bg-red-800":"bg-gray-300 text-gray-500 cursor-not-allowed opacity-70"}`,children:[u?e.jsx(J,{className:"w-5 h-5 animate-spin"}):e.jsx(j,{className:"w-5 h-5"})," افزودن به بایگانی"]})]})]})})]});const O=[{header:"کد سند",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.code}),sortKey:"code"},{header:"عنوان",accessor:t=>t.title,sortKey:"title"},{header:"نوع",accessor:t=>G(t.type)||t.type,sortKey:"type"},{header:"فایل",accessor:t=>t.file_url?e.jsx("a",{href:t.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-xs",children:"مشاهده"}):"-",sortKey:"file_url"},{header:"تاریخ ثبت",accessor:t=>t.created_at?new Date(t.created_at).toLocaleDateString("fa-IR"):"-",sortKey:"created_at"}];return e.jsx(V,{title:"آرشیو اسناد فنی",icon:j,data:F,isLoading:C,columns:O,onAdd:()=>d("NEW"),onReload:m,onDelete:T,selectedIds:b,onSelect:k,filterContent:M,exportName:"Documents",extraActions:U})};export{X as Documents,X as default};
