const u="report_templates_v1",m="report_templates_audit_v1",T={size:"A4",orientation:"portrait",marginTop:12,marginRight:12,marginBottom:12,marginLeft:12,keepTogether:!0},n=e=>String(e||"").trim().toLowerCase().replace(/[\/#]/g,"").replace(/[-_\s]/g,""),y=(e,t)=>{if(!e)return t;try{return JSON.parse(e)}catch{return t}},v=e=>{var t,r,o,i;return{...e,datasets:e.datasets||[],parameters:e.parameters||[],pageSettings:{...T,...e.pageSettings||{}},governance:{requiredRoles:((t=e.governance)==null?void 0:t.requiredRoles)||[],requiresApproval:!!((r=e.governance)!=null&&r.requiresApproval),approvedBy:((o=e.governance)==null?void 0:o.approvedBy)||null,approvedAt:((i=e.governance)==null?void 0:i.approvedAt)||null},elements:(e.elements||[]).map(a=>({...a,band:a.band||"detail"}))}},b=(e,t)=>{if(typeof window>"u")return;const r=y(localStorage.getItem(m),[]);r.push({id:`${Date.now()}-${Math.random().toString(36).slice(2,7)}`,event:e,templateId:t.id,moduleId:t.targetModule,version:t.version,at:new Date().toISOString()}),localStorage.setItem(m,JSON.stringify(r.slice(-500)))},g=()=>{if(typeof window>"u")return[];const e=y(localStorage.getItem(u),[]);return Array.isArray(e)?e.map(v):[]},s=e=>{const t=n(e);return g().filter(o=>o.targetModule===e||n(o.targetModule)===t).sort((o,i)=>(i.version||0)-(o.version||0))},w=e=>s(e).find(t=>t.isActive)||s(e)[0]||null,h=(e,t)=>{const r=e.targetModule,o=g(),a=s(r).reduce((d,A)=>Math.max(d,A.version||0),0),l=(t==null?void 0:t.activate)??!0,c=new Date().toISOString(),p=v({...e,id:e.id||`${r}-${Date.now()}`,version:a+1,isActive:l,createdAt:c,updatedAt:c,createdBy:(t==null?void 0:t.createdBy)||"سیستم",createdByUsername:(t==null?void 0:t.createdByUsername)||void 0});let f=[...o,p];return l&&(f=f.map(d=>n(d.targetModule)===n(r)?{...d,isActive:d.id===p.id}:d)),localStorage.setItem(u,JSON.stringify(f)),b("save",p),p},z=e=>{const t=g(),r=t.find(i=>i.id===e);if(!r)return;const o=t.map(i=>n(i.targetModule)!==n(r.targetModule)?i:{...i,isActive:i.id===e,updatedAt:new Date().toISOString()});localStorage.setItem(u,JSON.stringify(o)),b("set_active",r)},B=e=>{const t=g(),r=t.find(a=>a.id===e);if(!r)return;let o=t.filter(a=>a.id!==e);const i=o.filter(a=>n(a.targetModule)===n(r.targetModule));if(!i.some(a=>a.isActive)&&i.length>0){const a=i.sort((l,c)=>(c.version||0)-(l.version||0))[0];o=o.map(l=>l.id===a.id?{...l,isActive:!0}:l)}localStorage.setItem(u,JSON.stringify(o)),b("delete",r)},S=()=>({id:"",title:"قالب پیش فرض گزارش شیفت",targetModule:"shiftreport",elements:[{id:"shift-header",type:"HEADER",layout:{x:20,y:20,width:754,height:120},band:"reportHeader",props:{titleProps:{text:"شرکت توسعه معدنی و صنعتی صبانور",fontSize:20,bold:!0,color:"#800020",align:"center"},subtitleProps:{text:"گزارش شیفت تولید کارخانه کنسانتره همدان",fontSize:14,color:"#333333",align:"center"},detailsProps:{items:[{id:"d1",label:"کد رهگیری",value:"tracking_code"},{id:"d2",label:"تاریخ",value:"shift_date"},{id:"d3",label:"شیفت",value:"shift_name"},{id:"d4",label:"سرپرست",value:"supervisor_name"}],labelStyle:{fontSize:10,color:"#4b5563"},valueStyle:{fontSize:10,color:"#111827",bold:!0},dividerStyle:"dashed"},borderStyle:"BOTTOM",borderColor:"#800020",borderWidth:3}},{id:"shift-card-a",type:"STAT_CARD",layout:{x:20,y:160,width:240,height:100},band:"detail",props:{labelProps:{text:"خوراک مصرفی خط A",fontSize:12,bold:!0,color:"#1d4ed8",align:"center"},valueProps:{fontSize:24,bold:!0,color:"#1e40af",align:"center"},unitProps:{text:"تن",fontSize:11,color:"#6b7280",align:"center"},valueField:"total_production_a",backgroundColor:"#eff6ff",borderColor:"#bfdbfe",borderWidth:1}},{id:"shift-card-b",type:"STAT_CARD",layout:{x:280,y:160,width:240,height:100},band:"detail",props:{labelProps:{text:"خوراک مصرفی خط B",fontSize:12,bold:!0,color:"#b91c1c",align:"center"},valueProps:{fontSize:24,bold:!0,color:"#991b1b",align:"center"},unitProps:{text:"تن",fontSize:11,color:"#6b7280",align:"center"},valueField:"total_production_b",backgroundColor:"#fef2f2",borderColor:"#fecaca",borderWidth:1}},{id:"shift-meta",type:"TEXT",layout:{x:540,y:160,width:234,height:100},band:"detail",props:{textProps:{text:`نوع شیفت: {{shift_type}}
سرپرست: {{supervisor_name}}`,fontSize:12,color:"#374151",align:"right"},backgroundColor:"#f9fafb",borderColor:"#e5e7eb",borderWidth:1}},{id:"shift-main-table",type:"TABLE",layout:{x:20,y:280,width:754,height:150},band:"detail",props:{columns:[{id:"c1",key:"tracking_code",header:"کد گزارش",align:"right"},{id:"c2",key:"shift_date",header:"تاریخ",align:"center"},{id:"c3",key:"shift_name",header:"شیفت",align:"center"},{id:"c4",key:"shift_type",header:"نوع شیفت",align:"center"},{id:"c5",key:"supervisor_name",header:"سرپرست شیفت",align:"right"},{id:"c6",key:"total_production_a",header:"خوراک خط A",align:"center"},{id:"c7",key:"total_production_b",header:"خوراک خط B",align:"center"}],headerStyle:{bold:!0,color:"#111827",backgroundColor:"#f3f4f6"},rowStyle:{color:"#374151"},showRowNumber:!1}},{id:"shift-stop-reasons",type:"TEXT",layout:{x:20,y:450,width:754,height:96},band:"detail",props:{textProps:{text:`علت توقف خط A: {{downtime.lineA.reason}}
علت توقف خط B: {{downtime.lineB.reason}}`,fontSize:12,color:"#1f2937",align:"right"},backgroundColor:"#fffbeb",borderColor:"#fde68a",borderWidth:1}},{id:"shift-next-actions",type:"TEXT",layout:{x:20,y:560,width:754,height:90},band:"detail",props:{textProps:{text:"اقدامات شیفت بعد: {{footer.nextShiftActions}}",fontSize:12,color:"#14532d",align:"right"},backgroundColor:"#ecfdf5",borderColor:"#86efac",borderWidth:1}}],pageSettings:{size:"A4",orientation:"portrait",marginTop:12,marginRight:12,marginBottom:12,marginLeft:12,keepTogether:!0},governance:{requiredRoles:[],requiresApproval:!1,approvedBy:null,approvedAt:null}}),_=(e,t)=>({id:"",title:t,targetModule:e,elements:[{id:`${e}-header`,type:"HEADER",layout:{x:20,y:20,width:754,height:110},band:"reportHeader",props:{titleProps:{text:"سامانه یکپارچه گزارشات",fontSize:18,bold:!0,color:"#111827",align:"center"},subtitleProps:{text:t,fontSize:13,color:"#374151",align:"center"},detailsProps:{items:[{id:"g1",label:"کد رهگیری",value:"tracking_code"},{id:"g2",label:"تاریخ",value:"report_date"}],labelStyle:{fontSize:10,color:"#4b5563"},valueStyle:{fontSize:10,color:"#111827",bold:!0},dividerStyle:"dashed"},borderStyle:"BOTTOM",borderColor:"#d1d5db",borderWidth:2}},{id:`${e}-table`,type:"TABLE",layout:{x:20,y:150,width:754,height:460},band:"detail",props:{columns:[],headerStyle:{bold:!0,color:"#111827",backgroundColor:"#f3f4f6"},rowStyle:{color:"#374151"},showRowNumber:!1}}],pageSettings:{size:"A4",orientation:"portrait",marginTop:12,marginRight:12,marginBottom:12,marginLeft:12,keepTogether:!0},governance:{requiredRoles:[],requiresApproval:!1,approvedBy:null,approvedAt:null}}),M=()=>{if(typeof window>"u")return null;const e=s("shiftreport");return e.length>0?e.find(t=>t.isActive)||e[0]:h(S(),{activate:!0})},x={shiftreport:"قالب پیش فرض گزارش شیفت",productionreport:"قالب پیش فرض گزارش تولید","control-room":"قالب پیش فرض گزارش اتاق کنترل","lab-report":"قالب پیش فرض گزارش آزمایشگاه","warehouse-report":"قالب پیش فرض گزارش انبار","scale-report":"قالب پیش فرض گزارش باسکول","hse-report":"قالب پیش فرض گزارش HSE"},R=(e,t)=>{if(typeof window>"u")return null;const r=s(e);if(r.length>0)return r.find(i=>i.isActive)||r[0];if(n(e)===n("shiftreport"))return h(S(),{activate:!0});const o=t||x[e]||`قالب پیش فرض ${e}`;return h(_(e,o),{activate:!0})};export{w as a,h as b,R as c,B as d,M as e,g,z as s};
