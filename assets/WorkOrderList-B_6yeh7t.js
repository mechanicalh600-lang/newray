import{u as w,a3 as O,r as l,s as N,j as a,a4 as R,W as F,a5 as P,X as K,a6 as j}from"./index-Ba5jVD6p.js";import{WorkOrders as T}from"./WorkOrders-DzOXS3Jr.js";import"./paperclip-CYuFmfPe.js";const U=()=>{const k=w(),g=O(),[m,x]=l.useState([]),[I,f]=l.useState([]),[v,p]=l.useState(!0),[c,u]=l.useState(null),[h,S]=l.useState([]),[n,o]=l.useState("ALL"),[d,E]=l.useState(""),[i,_]=l.useState("");l.useEffect(()=>{const t=new URLSearchParams(g.search).get("status");t==="OPEN"?o("OPEN"):t==="FINISHED"?o("پایان"):t&&o(t)},[g.search]),l.useEffect(()=>{b()},[]);const b=async()=>{p(!0);try{const{data:e,error:t}=await N.from("work_orders").select("*").order("created_at",{ascending:!1}).limit(50);if(t)throw t;const r=(e||[]).map(s=>({id:s.id,trackingCode:s.tracking_code,title:`درخواست کار ${s.equipment_name||s.local_name||""}`,description:s.failure_description,status:s.status==="FINISHED"?"DONE":"PENDING",createdAt:s.request_date||new Date(s.created_at).toLocaleDateString("fa-IR"),updatedAt:s.request_date,module:"WORK_ORDER",workflowId:"legacy-db",currentStepId:"legacy-step",initiatorId:s.requester_id,assigneeRole:"ADMIN",data:{...s,equipName:s.equipment_name,equipLocalName:s.local_name,failureDesc:s.failure_description,requester:s.requester_name,status:s.status,equipment_code:s.equipment_code,request_time:s.request_time,workCategory:s.work_category}}));x(r),f(r)}catch(e){console.error("Error fetching work orders:",e)}finally{p(!1)}};l.useEffect(()=>{let e=m;n==="OPEN"?e=e.filter(t=>t.data.status!=="FINISHED"):n!=="ALL"&&(e=e.filter(t=>y(t).includes(n))),d&&(e=e.filter(t=>t.createdAt>=d)),i&&(e=e.filter(t=>t.createdAt<=i)),f(e)},[m,n,d,i]);const C=async e=>{await N.from("work_orders").delete().in("id",e),x(t=>t.filter(r=>!e.includes(r.id)))},y=e=>{var r;const t=(r=e.data)==null?void 0:r.status;return t==="REQUEST"?"درخواست جدید":t==="IN_PROGRESS"?"در حال انجام":t==="VERIFICATION"?"منتظر تایید":t==="FINISHED"?"پایان یافته":"نامشخص"},D=e=>{switch(e){case"MECHANICAL":return"مکانیک";case"ELECTRICAL":return"برق";case"INSTRUMENTATION":return"ابزار دقیق";case"FACILITIES":return"تأسیسات";default:return e||"-"}},L=e=>{const t=y(e);let r="bg-gray-100 text-gray-600";return t.includes("درخواست")?r="bg-blue-100 text-blue-700":t.includes("انجام")?r="bg-orange-100 text-orange-700":t.includes("تایید")?r="bg-purple-100 text-purple-700":t.includes("پایان")&&(r="bg-green-100 text-green-700"),a.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-bold ${r}`,children:t})},q=a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),a.jsxs("select",{value:n,onChange:e=>o(e.target.value),className:"w-full p-2.5 border rounded-lg bg-white dark:bg-gray-800",children:[a.jsx("option",{value:"ALL",children:"همه وضعیت‌ها"}),a.jsx("option",{value:"OPEN",children:"باز (جاری)"}),a.jsx("option",{value:"درخواست",children:"درخواست جدید"}),a.jsx("option",{value:"انجام",children:"در حال انجام"}),a.jsx("option",{value:"تایید",children:"منتظر تایید"}),a.jsx("option",{value:"پایان",children:"پایان یافته"})]})]}),a.jsx("div",{children:a.jsx(j,{label:"از تاریخ",value:d,onChange:E})}),a.jsx("div",{children:a.jsx(j,{label:"تا تاریخ",value:i,onChange:_})})]}),A=[{header:"کد پیگیری",accessor:e=>a.jsx("span",{className:"font-mono font-bold",children:e.trackingCode}),sortKey:"trackingCode"},{header:"کد تجهیز",accessor:e=>{var t;return a.jsx("span",{className:"font-mono text-sm",children:((t=e.data)==null?void 0:t.equipment_code)||"-"})},sortKey:"data.equipment_code"},{header:"نام تجهیز",accessor:e=>{var t,r;return((t=e.data)==null?void 0:t.equipLocalName)||((r=e.data)==null?void 0:r.local_name)||"-"},sortKey:"data.local_name"},{header:"شرح",accessor:e=>{var t;return a.jsx("span",{className:"truncate max-w-[200px] block",children:((t=e.data)==null?void 0:t.failureDesc)||e.title})},sortKey:"title"},{header:"دیسیپلین",accessor:e=>{var t;return D((t=e.data)==null?void 0:t.workCategory)},sortKey:"data.workCategory"},{header:"درخواست کننده",accessor:e=>{var t;return((t=e.data)==null?void 0:t.requester)||"ناشناس"},sortKey:"data.requester"},{header:"تاریخ",accessor:e=>a.jsx("span",{className:"font-mono text-xs",children:e.createdAt}),sortKey:"createdAt"},{header:"وضعیت",accessor:e=>L(e),sortKey:"status"}];return a.jsxs(a.Fragment,{children:[a.jsx(R,{title:"مدیریت دستور کارها",icon:F,data:I,isLoading:v,columns:A,onAdd:()=>k("/work-orders/new"),onReload:b,onDelete:C,selectedIds:h,onSelect:S,filterContent:q,onViewDetails:e=>u(e),exportName:"WorkOrders",extraActions:h.length===1&&a.jsx("button",{onClick:()=>alert("مشاهده PDF"),className:"p-2.5 bg-purple-50 text-purple-600 rounded-xl hover:bg-purple-100 transition",title:"چاپ",children:a.jsx(P,{className:"w-5 h-5"})})}),c&&a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm",children:a.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden animate-fadeIn",children:[a.jsxs("div",{className:"flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"font-bold text-lg",children:c.title}),a.jsx("span",{className:"bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-xs",children:c.trackingCode})]}),a.jsx("button",{onClick:()=>u(null),className:"p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full",children:a.jsx(K,{className:"w-6 h-6"})})]}),a.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-100 dark:bg-black/20 p-4",children:a.jsx(T,{initialData:c.data,isViewOnly:!0})}),a.jsx("div",{className:"p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-end",children:a.jsx("button",{onClick:()=>u(null),className:"px-6 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 transition",children:"بستن"})})]})})]})};export{U as WorkOrderList,U as default};
