import{c as D,r as o,s as u,j as t,P as W,a4 as $,bH as V,X}from"./index-Ba5jVD6p.js";import{A as G}from"./alert-circle-Bv2-lKAE.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=D("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=D("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),ee=()=>{const[g,P]=o.useState([]),[w,c]=o.useState(!1),[U,N]=o.useState([]),[S,A]=o.useState(!1),[F,f]=o.useState(!1),[h,k]=o.useState(null),[p,j]=o.useState([]),[C,v]=o.useState([]),[r,s]=o.useState({code:"",name:"",current_stock:0,min_stock:0,reorder_quantity:0,warehouse_row:"",shelf:"",unit_price:0,stock_unit_id:"",consumption_unit_id:"",temp_main_cat_id:"",temp_sub_cat_id:"",category_id:""});o.useEffect(()=>{_()},[]);const _=async()=>{c(!0);try{const e=[];let i=0,l=!0;for(;l;){const{data:n,error:m}=await u.from("parts").select("*").order("name").range(i,i+1e3-1);if(m)throw m;if(!n||n.length===0)break;e.push(...n),l=n.length===1e3,i+=1e3}P(e)}catch(e){console.error(e)}finally{c(!1)}},q=async()=>{const{data:e,error:a}=await u.from("part_categories").select("id, name, level_type, parent_id").order("name");if(a)throw a;return e||[]},I=async()=>{const{data:e,error:a}=await u.from("measurement_units").select("id, title, symbol").order("title");if(a)throw a;return e||[]},L=async()=>{k(null),s({code:"",name:"",current_stock:0,min_stock:0,reorder_quantity:0,warehouse_row:"",shelf:"",unit_price:0,stock_unit_id:"",consumption_unit_id:"",temp_main_cat_id:"",temp_sub_cat_id:"",category_id:""});try{const[e,a]=await Promise.all([q(),I()]);j(e),v(a)}catch(e){console.error(e),j([]),v([])}f(!0)},K=async e=>{k(e);const[a,i]=await Promise.all([q().catch(()=>[]),I().catch(()=>[])]);j(a),v(i);let l="",n="";const m=e.category_id;if(m&&a.length){const d=a.find(b=>b.id===m);if(d)if(d.level_type==="SUB_SUB"){n=d.parent_id||"";const b=a.find(T=>T.id===n);l=(b==null?void 0:b.parent_id)||""}else d.level_type==="SUB"?(l=d.parent_id||"",n=d.id):d.level_type==="MAIN"&&(l=d.id)}s({code:e.code||"",name:e.name||"",current_stock:Number(e.current_stock??0),min_stock:Number(e.min_stock??0),reorder_quantity:Number(e.reorder_quantity??0),warehouse_row:e.warehouse_row||"",shelf:e.shelf||"",unit_price:Number(e.unit_price??0),stock_unit_id:e.stock_unit_id||"",consumption_unit_id:e.consumption_unit_id||"",temp_main_cat_id:l,temp_sub_cat_id:n,category_id:m||""}),f(!0)},y=()=>{f(!1),k(null)},M=async e=>{var a,i;if(e.preventDefault(),!(!((a=r.name)!=null&&a.trim())||!((i=r.code)!=null&&i.trim()))){c(!0);try{const l={code:r.code.trim(),name:r.name.trim(),category_id:r.category_id||null,current_stock:r.current_stock,min_stock:r.min_stock,reorder_quantity:r.reorder_quantity,stock_unit_id:r.stock_unit_id||null,consumption_unit_id:r.consumption_unit_id||null,warehouse_row:r.warehouse_row.trim()||null,shelf:r.shelf.trim()||null,unit_price:r.unit_price};if(h!=null&&h.id){const{error:n}=await u.from("parts").update(l).eq("id",h.id);if(n)throw n}else{const{error:n}=await u.from("parts").insert(l);if(n)throw n}y(),await _()}catch(l){console.error(l),alert("خطا: "+(l.message||"خطا در ذخیره"))}finally{c(!1)}}},B=async e=>{if(e.length!==0){c(!0);try{const{error:a}=await u.from("parts").delete().in("id",e);if(a)throw a;N([]),await _()}catch(a){throw console.error(a),a}finally{c(!1)}}},E=S?g.filter(e=>(e.current_stock||0)<=(e.min_stock||0)):g,x=g.filter(e=>(e.current_stock||0)<=(e.min_stock||0)),z=g.reduce((e,a)=>e+(a.current_stock||0)*(a.unit_price||0),0),H=t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:S,onChange:e=>A(e.target.checked),className:"w-4 h-4 text-red-600 rounded focus:ring-red-500"}),t.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"نمایش فقط اقلام زیر نقطه سفارش"})]})}),O=[{header:"کد قطعه",accessor:e=>t.jsx("span",{className:"font-mono font-bold",children:e.code}),sortKey:"code"},{header:"نام قطعه",accessor:e=>e.name,sortKey:"name"},{header:"موجودی فعلی",accessor:e=>t.jsx("span",{className:`font-bold ${e.current_stock<=e.min_stock?"text-red-600":"text-green-600"}`,children:e.current_stock||0}),sortKey:"current_stock"},{header:"نقطه سفارش",accessor:e=>e.min_stock||0,sortKey:"min_stock"},{header:"ردیف انبار",accessor:e=>e.warehouse_row||"-",sortKey:"warehouse_row"},{header:"قفسه",accessor:e=>e.shelf||"-",sortKey:"shelf"},{header:"قیمت واحد (ریال)",accessor:e=>(e.unit_price||0).toLocaleString(),sortKey:"unit_price"},{header:"ارزش کل (ریال)",accessor:e=>((e.current_stock||0)*(e.unit_price||0)).toLocaleString()}],R=t.jsxs("div",{className:"space-y-6 mb-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-sm text-gray-500 block mb-1",children:"تعداد اقلام تعریف شده"}),t.jsx("span",{className:"text-2xl font-bold",children:g.length})]}),t.jsx("div",{className:"bg-blue-50 p-3 rounded-full text-blue-600",children:t.jsx(W,{className:"w-6 h-6"})})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-sm text-gray-500 block mb-1",children:"اقلام نیازمند سفارش"}),t.jsx("span",{className:"text-2xl font-bold text-red-600",children:x.length})]}),t.jsx("div",{className:"bg-red-50 p-3 rounded-full text-red-600",children:t.jsx(Q,{className:"w-6 h-6"})})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-sm text-gray-500 block mb-1",children:"ارزش کل موجودی"}),t.jsxs("span",{className:"text-xl font-bold text-green-700",children:[z.toLocaleString()," ",t.jsx("span",{className:"text-xs font-normal text-gray-500",children:"ریال"})]})]}),t.jsx("div",{className:"bg-green-50 p-3 rounded-full text-green-600",children:t.jsx(J,{className:"w-6 h-6"})})]})]}),x.length>0&&t.jsxs("div",{className:"bg-orange-50 border border-orange-200 text-orange-800 p-4 rounded-xl flex items-start gap-3 animate-fadeIn",children:[t.jsx(G,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-bold text-sm mb-1",children:"هشدار موجودی"}),t.jsxs("p",{className:"text-xs leading-relaxed",children:["موجودی کالاهای زیر به نقطه سفارش رسیده است:",x.map(e=>e.name).slice(0,5).join("، "),x.length>5&&` و ${x.length-5} مورد دیگر.`]})]})]})]});return t.jsxs(t.Fragment,{children:[t.jsx($,{title:"مدیریت موجودی انبار",icon:V,data:E,isLoading:w,columns:O,onReload:_,onAdd:L,onEdit:K,onDelete:B,selectedIds:U,onSelect:N,filterContent:H,exportName:"Inventory",children:R}),F&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:y,children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center",children:[t.jsx("h3",{className:"text-lg font-bold",children:h?"ویرایش قطعه":"افزودن قطعه جدید"}),t.jsx("button",{onClick:y,className:"p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700",children:t.jsx(X,{className:"w-5 h-5"})})]}),t.jsxs("form",{onSubmit:M,className:"p-6 space-y-4",children:[t.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/30 p-3 rounded-lg border border-gray-200 dark:border-gray-600",children:[t.jsx("h4",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 mb-2",children:"دسته‌بندی قطعه"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("select",{value:r.temp_main_cat_id,onChange:e=>s({...r,temp_main_cat_id:e.target.value,temp_sub_cat_id:"",category_id:""}),className:"w-full p-2.5 text-sm border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 outline-none",children:[t.jsx("option",{value:"",children:"۱. گروه اصلی قطعات..."}),p.filter(e=>e.level_type==="MAIN").map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:r.temp_sub_cat_id,onChange:e=>s({...r,temp_sub_cat_id:e.target.value,category_id:""}),disabled:!r.temp_main_cat_id,className:"w-full p-2.5 text-sm border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 outline-none disabled:opacity-50",children:[t.jsx("option",{value:"",children:"۲. گروه فرعی قطعات..."}),p.filter(e=>e.level_type==="SUB"&&e.parent_id===r.temp_main_cat_id).map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:r.category_id,onChange:e=>s({...r,category_id:e.target.value}),disabled:!r.temp_main_cat_id,className:"w-full p-2.5 text-sm border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 border-primary outline-none disabled:opacity-50",children:[t.jsx("option",{value:"",children:"۳. گروه فرعیِ فرعی قطعات..."}),r.temp_main_cat_id&&!r.temp_sub_cat_id&&p.filter(e=>e.id===r.temp_main_cat_id).map(e=>t.jsxs("option",{value:e.id,children:[e.name," (اصلی)"]},e.id)),r.temp_sub_cat_id&&p.filter(e=>e.id===r.temp_sub_cat_id).map(e=>t.jsxs("option",{value:e.id,children:[e.name," (فرعی)"]},e.id)),r.temp_sub_cat_id&&p.filter(e=>e.level_type==="SUB_SUB"&&e.parent_id===r.temp_sub_cat_id).map(e=>t.jsxs("option",{value:e.id,children:[e.name," (فرعی فرعی)"]},e.id))]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1",children:["کد قطعه ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",value:r.code,onChange:e=>s({...r,code:e.target.value}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none",required:!0})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1",children:["نام قطعه ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",value:r.name,onChange:e=>s({...r,name:e.target.value}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none",required:!0})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"واحد انبارش"}),t.jsxs("select",{value:r.stock_unit_id,onChange:e=>s({...r,stock_unit_id:e.target.value}),className:"w-full p-2.5 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 outline-none",children:[t.jsx("option",{value:"",children:"انتخاب..."}),C.map(e=>t.jsx("option",{value:e.id,children:e.title},e.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"واحد مصرف"}),t.jsxs("select",{value:r.consumption_unit_id,onChange:e=>s({...r,consumption_unit_id:e.target.value}),className:"w-full p-2.5 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 outline-none",children:[t.jsx("option",{value:"",children:"انتخاب..."}),C.map(e=>t.jsx("option",{value:e.id,children:e.title},e.id))]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"موجودی فعلی"}),t.jsx("input",{type:"number",min:0,value:r.current_stock,onChange:e=>s({...r,current_stock:Number(e.target.value)}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"نقطه سفارش"}),t.jsx("input",{type:"number",min:0,value:r.min_stock,onChange:e=>s({...r,min_stock:Number(e.target.value)}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"تعداد سفارش"}),t.jsx("input",{type:"number",min:0,value:r.reorder_quantity,onChange:e=>s({...r,reorder_quantity:Number(e.target.value)}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"قیمت واحد (ریال)"}),t.jsx("input",{type:"number",min:0,value:r.unit_price,onChange:e=>s({...r,unit_price:Number(e.target.value)}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"ردیف انبار"}),t.jsx("input",{type:"text",value:r.warehouse_row,onChange:e=>s({...r,warehouse_row:e.target.value}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none",placeholder:"مثال: 3"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"قفسه"}),t.jsx("input",{type:"text",value:r.shelf,onChange:e=>s({...r,shelf:e.target.value}),className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 dark:border-gray-600 outline-none",placeholder:"مثال: A"})]})]}),t.jsxs("div",{className:"flex gap-2 justify-end pt-4",children:[t.jsx("button",{type:"button",onClick:y,className:"px-4 py-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:"انصراف"}),t.jsx("button",{type:"submit",disabled:w,className:"px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 disabled:opacity-50",children:"ذخیره"})]})]})]})})]})};export{ee as Inventory,ee as default};
