import{u as I,r as l,s as h,j as r,a4 as R,bI as D,bj as T,ab as K,z as p,aa as F}from"./index-Ba5jVD6p.js";import{c as A}from"./reportTemplates-DFawh_qo.js";const W=({user:f})=>{const v=I(),[m,b]=l.useState([]),[d,y]=l.useState([]),[j,_]=l.useState(!1),[k,c]=l.useState("LIST"),[g,w]=l.useState([]),[i,N]=l.useState("ALL"),[s,o]=l.useState({report_date:"",truck_no:"",driver_name:"",material:"",gross_weight:"",tare_weight:"",net_weight:"",origin:"",destination:""});l.useEffect(()=>{A("scale-report","قالب پیش فرض گزارش باسکول"),u()},[]),l.useEffect(()=>{let e=m;i!=="ALL"&&(e=e.filter(t=>t.material===i)),y(e)},[m,i]);const u=async()=>{_(!0);try{const{data:e,error:t}=await h.from("scale_reports").select("*").order("created_at",{ascending:!1});if(t)throw t;e&&b(e)}catch(e){console.error("Error fetching scale reports:",e)}finally{_(!1)}},S=async e=>{try{const{error:t}=await h.from("scale_reports").delete().in("id",e);if(t)throw t;b(a=>a.filter(n=>!e.includes(n.id))),w([])}catch(t){console.error("Error deleting scale reports:",t),alert("خطا در حذف اطلاعات")}},C=()=>{const e=g.length>0?d.filter(n=>g.includes(n.id)):d,t=p.json_to_sheet(e),a=p.book_new();p.book_append_sheet(a,t,"ScaleReports"),F(a,`scale_reports_${Date.now()}.xlsx`)},E=r.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع محموله"}),r.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:i,onChange:e=>N(e.target.value),children:[r.jsx("option",{value:"ALL",children:"همه"}),r.jsx("option",{children:"کنسانتره سنگ آهن"}),r.jsx("option",{children:"سنگ آهن دانه بندی"}),r.jsx("option",{children:"گندله"})]})]})});if(k==="NEW"){const e=async()=>{if(!s.report_date||!s.truck_no.trim()||!s.material.trim()){alert("تاریخ، پلاک خودرو و نوع محموله الزامی است.");return}const t=Number(s.gross_weight||0),a=Number(s.tare_weight||0),n=s.net_weight?Number(s.net_weight):Math.max(0,t-a),L={tracking_code:await K("SC-"),report_date:s.report_date,truck_no:s.truck_no,driver_name:s.driver_name||null,material:s.material,gross_weight:t||null,tare_weight:a||null,net_weight:n||null,origin:s.origin||null,destination:s.destination||null,operator_id:f.id||null},{error:x}=await h.from("scale_reports").insert([L]);if(x){alert(`خطا در ثبت: ${x.message}`);return}alert("رکورد باسکول ثبت شد."),o({report_date:"",truck_no:"",driver_name:"",material:"",gross_weight:"",tare_weight:"",net_weight:"",origin:"",destination:""}),await u(),c("LIST")};return r.jsxs("div",{className:"max-w-3xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-xl shadow space-y-4",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"ثبت توزین جدید"}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"تاریخ"}),r.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:s.report_date,onChange:t=>o(a=>({...a,report_date:t.target.value})),placeholder:"1404/01/01"})]}),r.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"پلاک خودرو *",value:s.truck_no,onChange:t=>o(a=>({...a,truck_no:t.target.value}))}),r.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"نام راننده",value:s.driver_name,onChange:t=>o(a=>({...a,driver_name:t.target.value}))}),r.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"نوع محموله *",value:s.material,onChange:t=>o(a=>({...a,material:t.target.value}))}),r.jsx("input",{type:"number",min:"0",className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"وزن ناخالص",value:s.gross_weight,onChange:t=>o(a=>({...a,gross_weight:t.target.value}))}),r.jsx("input",{type:"number",min:"0",className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"وزن خالص",value:s.tare_weight,onChange:t=>o(a=>({...a,tare_weight:t.target.value}))}),r.jsx("input",{type:"number",min:"0",className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"وزن خالص (اختیاری)",value:s.net_weight,onChange:t=>o(a=>({...a,net_weight:t.target.value}))}),r.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"مبدا",value:s.origin,onChange:t=>o(a=>({...a,origin:t.target.value}))}),r.jsx("input",{className:"md:col-span-2 w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"مقصد",value:s.destination,onChange:t=>o(a=>({...a,destination:t.target.value}))})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{onClick:e,className:"bg-primary text-white px-4 py-2 rounded-lg",children:"ثبت نهایی"}),r.jsx("button",{onClick:()=>c("LIST"),className:"bg-gray-200 px-4 py-2 rounded-lg",children:"بازگشت"})]})]})}return r.jsx(R,{title:"گزارشات باسکول",icon:D,data:d,isLoading:j,columns:[{header:"کد گزارش",accessor:e=>r.jsx("span",{className:"font-mono font-bold",children:e.tracking_code}),sortKey:"tracking_code"},{header:"تاریخ",accessor:e=>e.report_date,sortKey:"report_date"},{header:"محموله",accessor:e=>e.material,sortKey:"material"},{header:"پلاک خودرو",accessor:e=>e.truck_no,sortKey:"truck_no"},{header:"وزن خالص",accessor:e=>e.net_weight,sortKey:"net_weight"},{header:"مبدا/مقصد",accessor:e=>`${e.origin||"-"} / ${e.destination||"-"}`,sortKey:"origin"}],selectedIds:g,onSelect:w,filterContent:E,onAdd:()=>c("NEW"),onReload:u,onDelete:S,onPrint:e=>T(v,"scale-report",e),onExport:C,exportName:"ScaleReports"})};export{W as ScaleReport,W as default};
