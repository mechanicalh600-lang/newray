import{u as T,r,s as p,j as e,a6 as u,a4 as L,bM as R,bj as H,ab as A}from"./index-Ba5jVD6p.js";import{c as F}from"./reportTemplates-DFawh_qo.js";const M=()=>{const f=T(),[h,n]=r.useState([]),[v,j]=r.useState([]),[N,m]=r.useState(!1),[y,d]=r.useState("LIST"),[w,x]=r.useState([]),[i,S]=r.useState("ALL"),[c,E]=r.useState(""),[g,k]=r.useState(""),[o,l]=r.useState({type:"INCIDENT",date:"",time:"",location:"",description:"",involved_persons:"",corrective_action:"",status:"OPEN"});r.useEffect(()=>{F("hse-report","قالب پیش فرض گزارش HSE"),p.from("hse_reports").select("*").order("created_at",{ascending:!1}).then(({data:t})=>n(t||[]))},[]);const C=async()=>{m(!0);const{data:t}=await p.from("hse_reports").select("*").order("created_at",{ascending:!1});n(t||[]),m(!1)};r.useEffect(()=>{let t=h;i!=="ALL"&&(t=t.filter(a=>a.type===i)),c&&(t=t.filter(a=>a.date>=c)),g&&(t=t.filter(a=>a.date<=g)),j(t)},[h,i,c,g]);const _=async t=>{n(a=>a.filter(s=>!t.includes(s.id))),x([])},D=e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع رویداد"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:i,onChange:t=>S(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"INCIDENT",children:"حادثه"}),e.jsx("option",{value:"NEAR_MISS",children:"شبه حادثه"})]})]}),e.jsx("div",{children:e.jsx(u,{label:"از تاریخ",value:c,onChange:E})}),e.jsx("div",{children:e.jsx(u,{label:"تا تاریخ",value:g,onChange:k})})]});if(y==="NEW"){const t=async()=>{if(!o.date||!o.description.trim()){alert("تاریخ و شرح رویداد الزامی است.");return}const s={tracking_code:await A("HSE-"),...o},{error:b}=await p.from("hse_reports").insert([s]);if(b){alert(`خطا در ثبت: ${b.message}`);return}alert("گزارش HSE ثبت شد."),n(I=>[{...s,id:`${Date.now()}`},...I]),d("LIST")};return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-xl shadow space-y-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"ثبت گزارش ایمنی و بهداشت"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع رویداد"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:o.type,onChange:a=>l(s=>({...s,type:a.target.value})),children:[e.jsx("option",{value:"INCIDENT",children:"حادثه"}),e.jsx("option",{value:"NEAR_MISS",children:"شبه حادثه"})]})]}),e.jsx(u,{label:"تاریخ رویداد",value:o.date,onChange:a=>l(s=>({...s,date:a}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"ساعت (مثال 08:30)",value:o.time,onChange:a=>l(s=>({...s,time:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"محل رخداد",value:o.location,onChange:a=>l(s=>({...s,location:a.target.value}))}),e.jsx("textarea",{className:"md:col-span-2 w-full p-2 border rounded-lg bg-white dark:bg-gray-700 min-h-[90px]",placeholder:"شرح رویداد *",value:o.description,onChange:a=>l(s=>({...s,description:a.target.value}))}),e.jsx("input",{className:"md:col-span-2 w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"افراد درگیر",value:o.involved_persons,onChange:a=>l(s=>({...s,involved_persons:a.target.value}))}),e.jsx("textarea",{className:"md:col-span-2 w-full p-2 border rounded-lg bg-white dark:bg-gray-700 min-h-[90px]",placeholder:"اقدام اصلاحی",value:o.corrective_action,onChange:a=>l(s=>({...s,corrective_action:a.target.value}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:t,className:"bg-primary text-white px-4 py-2 rounded-lg",children:"ثبت نهایی"}),e.jsx("button",{onClick:()=>d("LIST"),className:"bg-gray-200 px-4 py-2 rounded-lg",children:"بازگشت"})]})]})}return e.jsx(L,{title:"گزارشات ایمنی و بهداشت (HSE)",icon:R,data:v,isLoading:N,onAdd:()=>d("NEW"),onReload:C,onDelete:_,selectedIds:w,onSelect:x,filterContent:D,onEdit:()=>d("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),onPrint:t=>H(f,"hse-report",t),exportName:"HSEReports",columns:[{header:"کد گزارش",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code}),sortKey:"tracking_code"},{header:"تاریخ",accessor:t=>t.date,sortKey:"date"},{header:"نوع",accessor:t=>t.type,sortKey:"type"},{header:"شرح",accessor:t=>t.description,sortKey:"description"}]})};export{M as HSEReport,M as default};
