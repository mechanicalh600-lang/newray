import{r as l,w as $,s as y,j as e,_ as H,bq as W,ay as K,Q as U,V as z,Y as Q,a2 as B,R as G,aD as J,a6 as X,z as f,aa as Z}from"./index-Ba5jVD6p.js";import{P as ee}from"./play-BMO1cnzw.js";const se=({user:ae})=>{const[j,N]=l.useState([]),[i,_]=l.useState([]),[v,k]=l.useState(!1),[S,m]=l.useState(!1),[C,L]=l.useState([]),[o,E]=l.useState(""),[d,u]=l.useState([]),[h,I]=l.useState(!1),[x,P]=l.useState("ALL"),[g,O]=l.useState("ALL"),[T,p]=l.useState(!1),[t,c]=l.useState({title:"",equipmentId:"",frequencyType:"WEEKLY",frequencyValue:1,nextRunDate:"",description:""});l.useEffect(()=>{b(),$("equipment").then(L)},[]),l.useEffect(()=>{let a=j;if(o&&(a=a.filter(r=>{var n,s;return r.title.includes(o)||((n=r.equipName)==null?void 0:n.includes(o))||((s=r.equipCode)==null?void 0:s.includes(o))})),x!=="ALL"&&(a=a.filter(r=>r.frequency_type===x)),g!=="ALL"){const r=g==="ACTIVE";a=a.filter(n=>n.is_active===r)}_(a)},[j,o,x,g]);const b=async()=>{k(!0);try{const{data:a,error:r}=await y.from("pm_plans").select("*, equipment(name, code)").order("created_at",{ascending:!1});if(!r&&a){const n=a.map(s=>{var w,q;return{...s,equipName:((w=s.equipment)==null?void 0:w.name)||"---",equipCode:((q=s.equipment)==null?void 0:q.code)||"---"}});N(n)}}catch(a){console.error(a)}finally{k(!1)}},D=async a=>{a.preventDefault();try{const r={title:t.title,equipment_id:t.equipmentId,frequency_type:t.frequencyType,frequency_value:t.frequencyValue,next_run_date:t.nextRunDate,description:t.description,is_active:!0};await y.from("pm_plans").insert([r]),m(!1),b(),alert("برنامه نت با موفقیت ایجاد شد."),c({title:"",equipmentId:"",frequencyType:"WEEKLY",frequencyValue:1,nextRunDate:"",description:""})}catch{alert("خطا در ثبت برنامه.")}},F=async()=>{try{const{error:a}=await y.from("pm_plans").delete().in("id",d);if(a)throw a;N(r=>r.filter(n=>!d.includes(n.id))),u([]),p(!1)}catch{alert("خطا در حذف.")}},M=()=>{alert(`صدور دستور کار برای ${d.length} مورد انتخاب شده انجام شد (شبیه‌سازی).`),u([])},A=()=>{if(i.length===0)return alert("داده‌ای برای خروجی وجود ندارد");const a=i.map(s=>({"عنوان برنامه":s.title,تجهیز:s.equipName,"کد تجهیز":s.equipCode,"نوع تکرار":s.frequency_type,مقدار:s.frequency_value,"اجرای بعدی":s.next_run_date,وضعیت:s.is_active?"فعال":"غیرفعال"})),r=f.json_to_sheet(a),n=f.book_new();f.book_append_sheet(n,r,"PM_Plans"),Z(n,`pm_scheduler_${Date.now()}.xlsx`)},R=(a,r)=>a==="WEEKLY"?`هر ${r} هفته`:a==="MONTHLY"?`هر ${r} ماه`:a==="HOURS"?`هر ${r} ساعت کارکرد`:a,V=a=>{a.target.checked?u(i.map(r=>r.id)):u([])},Y=a=>{d.includes(a)?u(r=>r.filter(n=>n!==a)):u(r=>[...r,a])};return e.jsxs("div",{className:"max-w-7xl mx-auto pb-20 p-4",children:[e.jsx(H,{isOpen:T,onClose:()=>p(!1),onConfirm:F,title:"حذف برنامه نت",message:`آیا مطمئن هستید که می‌خواهید ${d.length} برنامه انتخاب شده را حذف کنید؟ این عملیات غیرقابل بازگشت است.`}),e.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm",children:e.jsx(W,{className:"w-6 h-6 text-primary"})}),e.jsx("h1",{className:"text-2xl font-bold",children:"زمان‌بندی نت پیشگیرانه (PM)"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden mb-6",children:[e.jsxs("div",{className:"p-4 flex flex-col md:flex-row items-center gap-4 justify-between",children:[e.jsxs("div",{className:"relative flex-1 w-full md:max-w-md",children:[e.jsx(K,{className:"absolute right-3 top-2.5 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"جستجو در برنامه‌ها (عنوان، تجهیز...)",value:o,onChange:a=>E(a.target.value),className:"w-full pr-10 pl-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-primary"})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-auto justify-end",children:[d.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:M,className:"p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition flex items-center gap-2",title:"صدور دستور کار",children:[e.jsx(ee,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-bold hidden md:inline",children:"صدور دستور کار"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-1"}),d.length===1&&e.jsx("button",{className:"p-2 bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 transition",title:"ویرایش",onClick:()=>alert("ویرایش (پیاده‌سازی نشده)"),children:e.jsx(U,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>p(!0),className:"p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition",title:"حذف",children:e.jsx(z,{className:"w-5 h-5"})})]}),e.jsx("button",{onClick:()=>m(!0),className:"p-2 bg-cyan-50 text-cyan-600 rounded-lg hover:bg-cyan-100 transition",title:"تعریف برنامه جدید",children:e.jsx(Q,{className:"w-5 h-5"})}),e.jsx("button",{onClick:A,className:"p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition",title:"خروجی اکسل",children:e.jsx(B,{className:"w-5 h-5"})}),e.jsx("button",{onClick:b,className:"p-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition",title:"بروزرسانی",children:e.jsx(G,{className:`w-5 h-5 ${v?"animate-spin":""}`})}),e.jsx("button",{onClick:()=>I(!h),className:`p-2 rounded-lg border transition ${h?"bg-primary/10 border-primary text-primary":"bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500"}`,title:"فیلترها",children:e.jsx(J,{className:"w-5 h-5"})})]})]}),h&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 border-t border-gray-100 dark:border-gray-700 p-4 animate-fadeIn grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع تکرار"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 outline-none",value:x,onChange:a=>P(a.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"WEEKLY",children:"هفتگی"}),e.jsx("option",{value:"MONTHLY",children:"ماهانه"}),e.jsx("option",{value:"HOURS",children:"ساعت کارکرد"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 outline-none",value:g,onChange:a=>O(a.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"ACTIVE",children:"فعال"}),e.jsx("option",{value:"INACTIVE",children:"غیرفعال"})]})]})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-100 dark:border-gray-700",children:e.jsx("div",{className:"overflow-x-auto min-h-[520px]",children:e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-gray-500 font-medium",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-4 w-10",children:e.jsx("input",{type:"checkbox",onChange:V,checked:i.length>0&&d.length===i.length,className:"w-4 h-4 rounded text-primary focus:ring-primary cursor-pointer"})}),e.jsx("th",{className:"p-4",children:"عنوان برنامه"}),e.jsx("th",{className:"p-4",children:"تجهیز"}),e.jsx("th",{className:"p-4",children:"تکرار"}),e.jsx("th",{className:"p-4",children:"اجرای بعدی"}),e.jsx("th",{className:"p-4",children:"آخرین اجرا"}),e.jsx("th",{className:"p-4",children:"وضعیت"})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:v?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-gray-400",children:"در حال دریافت اطلاعات..."})}):i.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-gray-400",children:"موردی یافت نشد."})}):i.map(a=>e.jsxs("tr",{className:`hover:bg-gray-50 dark:hover:bg-gray-700/50 transition ${d.includes(a.id)?"bg-blue-50 dark:bg-blue-900/10":""}`,children:[e.jsx("td",{className:"p-4",children:e.jsx("input",{type:"checkbox",checked:d.includes(a.id),onChange:()=>Y(a.id),className:"w-4 h-4 rounded text-primary focus:ring-primary cursor-pointer"})}),e.jsx("td",{className:"p-4 font-bold text-gray-700 dark:text-gray-200",children:a.title}),e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a.equipName}),e.jsx("span",{className:"text-xs text-gray-400 font-mono",children:a.equipCode})]})}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:"bg-blue-50 text-blue-700 px-2 py-1 rounded-lg text-xs font-bold border border-blue-100",children:R(a.frequency_type,a.frequency_value)})}),e.jsx("td",{className:"p-4 font-mono text-gray-600 dark:text-gray-300",children:a.next_run_date||"تعیین نشده"}),e.jsx("td",{className:"p-4 font-mono text-gray-500",children:a.last_run_date||"-"}),e.jsx("td",{className:"p-4",children:a.is_active?e.jsx("span",{className:"text-green-600 text-xs font-bold bg-green-50 px-2 py-1 rounded border border-green-100",children:"فعال"}):e.jsx("span",{className:"text-gray-400 text-xs bg-gray-100 px-2 py-1 rounded border border-gray-200",children:"غیرفعال"})})]},a.id))})]})})}),S&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:e.jsxs("form",{onSubmit:D,className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 space-y-4 animate-scaleIn",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 text-gray-800 dark:text-white",children:"تعریف برنامه PM جدید"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"عنوان برنامه"}),e.jsx("input",{required:!0,className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:t.title,onChange:a=>c({...t,title:a.target.value}),placeholder:"مثال: سرویس ماهیانه پمپ..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"تجهیز مرتبط"}),e.jsxs("select",{required:!0,className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:t.equipmentId,onChange:a=>c({...t,equipmentId:a.target.value}),children:[e.jsx("option",{value:"",children:"انتخاب تجهیز..."}),C.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.code,")"]},a.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"نوع تکرار"}),e.jsxs("select",{className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:t.frequencyType,onChange:a=>c({...t,frequencyType:a.target.value}),children:[e.jsx("option",{value:"WEEKLY",children:"هفتگی"}),e.jsx("option",{value:"MONTHLY",children:"ماهانه"}),e.jsx("option",{value:"HOURS",children:"کارکرد (ساعت)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"مقدار بازه"}),e.jsx("input",{type:"number",min:"1",className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 text-center outline-none focus:ring-2 focus:ring-primary",value:t.frequencyValue,onChange:a=>c({...t,frequencyValue:Number(a.target.value)})})]})]}),e.jsx("div",{children:e.jsx(X,{label:"تاریخ اولین اجرا",value:t.nextRunDate,onChange:a=>c({...t,nextRunDate:a}),disableFuture:!1})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1 font-medium text-gray-700 dark:text-gray-300",children:"توضیحات / چک لیست"}),e.jsx("textarea",{className:"w-full p-2.5 border rounded-xl dark:bg-gray-700 h-24 outline-none focus:ring-2 focus:ring-primary",value:t.description,onChange:a=>c({...t,description:a.target.value}),placeholder:"شرح کارهایی که باید انجام شود..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:()=>m(!1),className:"flex-1 border py-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition",children:"انصراف"}),e.jsx("button",{type:"submit",className:"flex-1 bg-primary text-white py-2.5 rounded-xl hover:bg-red-800 transition shadow-lg",children:"ذخیره برنامه"})]})]})})]})};export{se as PMScheduler,se as default};
