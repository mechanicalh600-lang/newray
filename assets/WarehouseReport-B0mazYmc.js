import{u as I,r as o,s as u,j as e,a6 as g,a4 as q,bH as W,bj as K,ab as F}from"./index-Ba5jVD6p.js";import{c as P}from"./reportTemplates-DFawh_qo.js";const $=({user:y})=>{const v=I(),[m,h]=o.useState([]),[_,j]=o.useState([]),[w,x]=o.useState(!1),[N,n]=o.useState("LIST"),[k,b]=o.useState([]),[S,T]=o.useState([]),[d,E]=o.useState("ALL"),[i,C]=o.useState(""),[c,D]=o.useState(""),[s,l]=o.useState({report_date:"",type:"ENTRY",part_id:"",qty:"",unit:"",receiver_name:"",doc_ref:""});o.useEffect(()=>{P("warehouse-report","قالب پیش فرض گزارش انبار"),p(),u.from("parts").select("id,name").order("name",{ascending:!0}).then(({data:t})=>T(t||[]))},[]),o.useEffect(()=>{let t=m;d!=="ALL"&&(t=t.filter(a=>a.type===d)),i&&(t=t.filter(a=>a.report_date>=i)),c&&(t=t.filter(a=>a.report_date<=c)),j(t)},[m,d,i,c]);const p=async()=>{x(!0);const{data:t}=await u.from("warehouse_reports").select("*, parts(name)").order("created_at",{ascending:!1});t&&h(t.map(a=>{var r;return{...a,part_name:((r=a.parts)==null?void 0:r.name)||"-"}})),x(!1)},R=async t=>{await u.from("warehouse_reports").delete().in("id",t),h(a=>a.filter(r=>!t.includes(r.id))),b([])},L=e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع تراکنش"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:d,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"ENTRY",children:"ورود"}),e.jsx("option",{value:"EXIT",children:"خروج"})]})]}),e.jsx("div",{children:e.jsx(g,{label:"از تاریخ",value:i,onChange:C})}),e.jsx("div",{children:e.jsx(g,{label:"تا تاریخ",value:c,onChange:D})})]});if(N==="NEW"){const t=async()=>{if(!s.report_date||!s.part_id||!s.qty){alert("تاریخ، کالا و تعداد الزامی است.");return}const r={tracking_code:await F("WH-"),report_date:s.report_date,type:s.type,part_id:s.part_id,qty:Number(s.qty),unit:s.unit||null,receiver_name:s.receiver_name||null,doc_ref:s.doc_ref||null,operator_id:y.id||null},{error:f}=await u.from("warehouse_reports").insert([r]);if(f){alert(`خطا در ثبت: ${f.message}`);return}alert("سند انبار ثبت شد."),l({report_date:"",type:"ENTRY",part_id:"",qty:"",unit:"",receiver_name:"",doc_ref:""}),await p(),n("LIST")};return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-xl shadow space-y-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"ثبت سند انبار"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(g,{label:"تاریخ",value:s.report_date,onChange:a=>l(r=>({...r,report_date:a}))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"نوع سند"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:s.type,onChange:a=>l(r=>({...r,type:a.target.value})),children:[e.jsx("option",{value:"ENTRY",children:"ورود"}),e.jsx("option",{value:"EXIT",children:"خروج"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"کالا *"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:s.part_id,onChange:a=>l(r=>({...r,part_id:a.target.value})),children:[e.jsx("option",{value:"",children:"انتخاب کالا..."}),S.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"تعداد *"}),e.jsx("input",{type:"number",min:"0",className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:s.qty,onChange:a=>l(r=>({...r,qty:a.target.value}))})]}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"واحد",value:s.unit,onChange:a=>l(r=>({...r,unit:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"گیرنده/تحویل‌گیرنده",value:s.receiver_name,onChange:a=>l(r=>({...r,receiver_name:a.target.value}))}),e.jsx("input",{className:"md:col-span-2 w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"شماره سند/حواله",value:s.doc_ref,onChange:a=>l(r=>({...r,doc_ref:a.target.value}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:t,className:"bg-primary text-white px-4 py-2 rounded-lg",children:"ثبت نهایی"}),e.jsx("button",{onClick:()=>n("LIST"),className:"bg-gray-200 px-4 py-2 rounded-lg",children:"بازگشت"})]})]})}return e.jsx(q,{title:"گزارشات انبار",icon:W,data:_,isLoading:w,onAdd:()=>n("NEW"),onReload:p,onDelete:R,selectedIds:k,onSelect:b,filterContent:L,onEdit:()=>n("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),onPrint:t=>K(v,"warehouse-report",t),exportName:"WarehouseReports",columns:[{header:"کد گزارش",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code}),sortKey:"tracking_code"},{header:"تاریخ",accessor:t=>t.report_date,sortKey:"report_date"},{header:"نوع",accessor:t=>t.type==="ENTRY"?"ورود":"خروج",sortKey:"type"},{header:"کالا",accessor:t=>t.part_name,sortKey:"part_name"},{header:"تعداد",accessor:t=>`${t.qty} ${t.unit||""}`,sortKey:"qty"},{header:"تحویل گیرنده",accessor:t=>t.receiver_name,sortKey:"receiver_name"}]})};export{$ as WarehouseReport,$ as default};
