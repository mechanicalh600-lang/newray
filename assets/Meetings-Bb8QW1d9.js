import{r as n,h as T,w as _,s as f,j as t,ad as D,X,a6 as C,ae as E,a0 as Y,Y as z,V as B,d as H,F as J,a4 as Q,ab as Z,af as ee}from"./index-Ba5jVD6p.js";const te=["رئیس جلسه","دبیر","عضو","ناظر","مهمان"],re=({user:ae})=>{const[p,y]=n.useState([]),[L,M]=n.useState([]),[A,v]=n.useState(!1),[F,u]=n.useState("LIST"),[I,N]=n.useState([]),[o,K]=n.useState(""),[P,R]=n.useState([]),[V,W]=n.useState([]),[a,i]=n.useState({subject:"",location:"",meetingDate:T(),startTime:"08:00",endTime:"10:00"}),[c,x]=n.useState([]),[l,m]=n.useState({name:"",role:""}),[g,k]=n.useState(!1);n.useEffect(()=>{b(),_("personnel").then(e=>R(e||[])),_("user_groups").then(e=>{const s=(e||[]).map(r=>({id:r.id,name:r.name||r.code||"-"}));W(s.length>0?s:te.map((r,d)=>({id:String(d),name:r})))})},[]),n.useEffect(()=>{let e=p;o&&(e=e.filter(s=>s.meeting_date===o)),M(e)},[p,o]);const b=async()=>{v(!0);const{data:e}=await f.from("meeting_minutes").select("*").order("created_at",{ascending:!1});e&&y(e),v(!1)},$=async e=>{await f.from("meeting_minutes").delete().in("id",e),y(s=>s.filter(r=>!e.includes(r.id))),N([])},w=()=>!a.startTime||!a.endTime?!0:ee(a.meetingDate,a.startTime,a.meetingDate,a.endTime)<0,q=()=>{var e;(e=l.name)!=null&&e.trim()&&(x(s=>[...s,{name:l.name.trim(),role:l.role||"-"}]),m({name:"",role:""}))},G=e=>x(s=>s.filter((r,d)=>d!==e)),h=()=>{var e;return!!((e=a.subject)!=null&&e.trim())&&c.length>0&&w()},j=()=>{i({subject:"",location:"",meetingDate:T(),startTime:"08:00",endTime:"10:00"}),x([]),m({name:"",role:""}),u("LIST")},O=async e=>{var s;if(e.preventDefault(),!(!h()||g)){k(!0);try{const r=await Z("MT"),{error:d}=await f.from("meeting_minutes").insert({tracking_code:r,subject:a.subject.trim(),location:((s=a.location)==null?void 0:s.trim())||null,meeting_date:a.meetingDate,start_time:a.startTime,end_time:a.endTime,attendees:c.map(S=>({name:S.name,role:S.role})),status:"DRAFT"});if(d)throw d;alert("صورتجلسه با موفقیت ثبت شد."),j(),b()}catch(r){alert("خطا: "+((r==null?void 0:r.message)||"خطا در ذخیره"))}finally{k(!1)}}},U=t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:t.jsx("div",{children:t.jsx(C,{label:"تاریخ جلسه",value:o,onChange:K})})});return F==="NEW"?t.jsxs("div",{className:"max-w-2xl mx-auto pb-20",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white",children:[t.jsx(D,{className:"w-6 h-6 text-primary"})," ثبت صورتجلسه"]}),t.jsx("button",{onClick:j,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:t.jsx(X,{className:"w-5 h-5"})})]}),t.jsxs("form",{onSubmit:O,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm space-y-6 border border-gray-200 dark:border-gray-700",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"md:col-span-2",children:[t.jsxs("label",{className:"block text-sm mb-1 font-medium",children:["موضوع جلسه ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",value:a.subject,onChange:e=>i({...a,subject:e.target.value}),required:!0,className:"w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",placeholder:"عنوان اصلی جلسه..."})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm mb-1 font-medium",children:"محل برگزاری"}),t.jsx("input",{type:"text",value:a.location,onChange:e=>i({...a,location:e.target.value}),className:"w-full p-2.5 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary"})]}),t.jsx("div",{children:t.jsx(C,{label:"تاریخ برگزاری",value:a.meetingDate,onChange:e=>i({...a,meetingDate:e})})}),t.jsx("div",{children:t.jsx(E,{label:"ساعت شروع",value:a.startTime,onChange:e=>i({...a,startTime:e})})}),t.jsx("div",{children:t.jsx(E,{label:"ساعت اتمام",value:a.endTime,onChange:e=>i({...a,endTime:e}),error:a.endTime&&!w()?"ساعت اتمام باید بعد از شروع باشد":void 0})})]}),t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-100 dark:border-blue-800",children:[t.jsxs("label",{className:"block text-sm mb-3 font-bold flex items-center gap-2 text-blue-800 dark:text-blue-300",children:[t.jsx(Y,{className:"w-4 h-4"})," حاضرین در جلسه ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsxs("div",{className:"flex gap-2 mb-3 items-end",children:[t.jsxs("div",{className:"flex-[1] min-w-0",children:[t.jsx("label",{className:"text-xs text-gray-500 block mb-1",children:"نام شخص"}),t.jsxs("select",{className:"w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 outline-none text-sm",value:l.name,onChange:e=>m({...l,name:e.target.value}),children:[t.jsx("option",{value:"",children:"انتخاب..."}),(P||[]).map(e=>t.jsx("option",{value:e.full_name,children:e.full_name},e.id))]})]}),t.jsxs("div",{className:"flex-[2] min-w-0",children:[t.jsx("label",{className:"text-xs text-gray-500 block mb-1",children:"سمت / مسئولیت"}),t.jsxs("select",{className:"w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 outline-none text-sm",value:l.role,onChange:e=>m({...l,role:e.target.value}),children:[t.jsx("option",{value:"",children:"انتخاب..."}),V.map(e=>t.jsx("option",{value:e.name,children:e.name},e.id))]})]}),t.jsx("button",{type:"button",onClick:q,className:"bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 h-[38px] w-[38px] flex items-center justify-center",children:t.jsx(z,{className:"w-5 h-5"})})]}),c.length>0?t.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:c.map((e,s)=>t.jsxs("div",{className:"flex justify-between items-center p-2 border-b last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[t.jsx("span",{className:"font-bold",children:e.name}),t.jsx("span",{className:"text-gray-400 text-xs",children:"|"}),t.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-xs",children:e.role})]}),t.jsx("button",{type:"button",onClick:()=>G(s),className:"text-red-500 hover:bg-red-50 p-1 rounded",children:t.jsx(B,{className:"w-4 h-4"})})]},s))}):t.jsx("p",{className:"text-xs text-gray-500 text-center py-2 bg-white/50 rounded border border-dashed",children:"هنوز کسی اضافه نشده است."})]}),t.jsxs("div",{className:"flex gap-3 pt-4 border-t dark:border-gray-700",children:[t.jsx("button",{type:"button",onClick:j,className:"flex-1 border border-gray-300 dark:border-gray-600 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-500",children:"انصراف"}),t.jsxs("button",{type:"submit",disabled:!h()||g,className:`flex-[2] text-white py-3 rounded-xl shadow hover:bg-red-800 flex justify-center gap-2 font-bold transition ${h()&&!g?"bg-primary":"bg-gray-400 cursor-not-allowed"}`,children:[g?t.jsx(H,{className:"w-5 h-5 animate-spin"}):t.jsx(J,{className:"w-5 h-5"})," ثبت نهایی صورتجلسه"]})]})]})]}):t.jsx(Q,{title:"مدیریت صورتجلسات",icon:D,data:L,isLoading:A,onAdd:()=>u("NEW"),onReload:b,onDelete:$,selectedIds:I,onSelect:N,filterContent:U,onEdit:()=>u("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),exportName:"Meetings",columns:[{header:"کد پیگیری",accessor:e=>t.jsx("span",{className:"font-mono font-bold",children:e.tracking_code||"-"}),sortKey:"tracking_code"},{header:"موضوع جلسه",accessor:e=>e.subject,sortKey:"subject"},{header:"تاریخ",accessor:e=>e.meeting_date||"-",sortKey:"meeting_date"},{header:"ساعت",accessor:e=>e.start_time&&e.end_time?`${e.start_time} - ${e.end_time}`:"-",sortKey:"start_time"},{header:"مکان",accessor:e=>e.location||"-",sortKey:"location"},{header:"حاضرین",accessor:e=>(Array.isArray(e.attendees)?e.attendees.map(s=>s.name).join(" | "):"-")||"-",sortKey:"attendees"}]})};export{re as Meetings,re as default};
