import{r as t,w as P,s as d,j as l,a6 as v,d as B,F as M,a4 as q,ao as O}from"./index-Ba5jVD6p.js";const m=[{value:"Beginner",label:"مقدماتی"},{value:"Intermediate",label:"متوسط"},{value:"Expert",label:"پیشرفته / مدرس"}],j={personnelId:"",skillName:"",level:"Beginner",certDate:"",expiryDate:""},V=()=>{const[p,g]=t.useState([]),[y,k]=t.useState([]),[N,x]=t.useState(!1),[S,f]=t.useState([]),[i,_]=t.useState("ALL"),[L,o]=t.useState(!1),[s,n]=t.useState(j),[w,D]=t.useState([]),[C,I]=t.useState([]),[c,h]=t.useState(!1);t.useEffect(()=>{u()},[]),t.useEffect(()=>{P("personnel").then(e=>D(e||[])),d.from("training_courses").select("id, title").order("title").then(({data:e})=>I(e||[]))},[]),t.useEffect(()=>{let e=p;i!=="ALL"&&(e=e.filter(a=>a.level===i)),k(e)},[p,i]);const u=async()=>{x(!0);const{data:e}=await d.from("personnel_skills").select("*, personnel(full_name, personnel_code)").order("created_at",{ascending:!1});e&&g(e.map(a=>{var r,b;return{...a,full_name:(r=a.personnel)==null?void 0:r.full_name,personnel_code:(b=a.personnel)==null?void 0:b.personnel_code}})),x(!1)},E=async e=>{await d.from("personnel_skills").delete().in("id",e),g(a=>a.filter(r=>!e.includes(r.id))),f([])},K=async e=>{if(e.preventDefault(),!(!s.personnelId||!s.skillName||c)){h(!0);try{await d.from("personnel_skills").insert({personnel_id:s.personnelId,skill_name:s.skillName,level:s.level||null,certificate_date:s.certDate||null,expiry_date:s.expiryDate||null}),alert("مهارت با موفقیت ثبت شد."),o(!1),n(j),u()}catch(a){alert("خطا: "+((a==null?void 0:a.message)||"خطا در ذخیره"))}finally{h(!1)}}},A=e=>{var a;return((a=m.find(r=>r.value===e))==null?void 0:a.label)||e},F=l.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:l.jsxs("div",{children:[l.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"سطح تسلط"}),l.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:i,onChange:e=>_(e.target.value),children:[l.jsx("option",{value:"ALL",children:"همه"}),m.map(e=>l.jsx("option",{value:e.value,children:e.label},e.value))]})]})});return l.jsxs(l.Fragment,{children:[L&&l.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",onClick:()=>o(!1),children:l.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg p-6 space-y-4",onClick:e=>e.stopPropagation(),children:l.jsxs("form",{onSubmit:K,children:[l.jsx("h3",{className:"font-bold text-lg mb-4",children:"ثبت مهارت جدید"}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm mb-1 font-bold",children:["پرسنل ",l.jsx("span",{className:"text-red-500",children:"*"})]}),l.jsxs("select",{required:!0,className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:s.personnelId,onChange:e=>n({...s,personnelId:e.target.value}),children:[l.jsx("option",{value:"",children:"انتخاب کنید..."}),(w||[]).map(e=>l.jsx("option",{value:e.id,children:e.full_name},e.id))]})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm mb-1 font-bold",children:["عنوان مهارت / دوره ",l.jsx("span",{className:"text-red-500",children:"*"})]}),l.jsxs("select",{required:!0,className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:s.skillName,onChange:e=>n({...s,skillName:e.target.value}),children:[l.jsx("option",{value:"",children:"انتخاب دوره آموزشی..."}),(C||[]).map(e=>l.jsx("option",{value:e.title,children:e.title},e.id))]})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm mb-1 font-bold",children:"سطح تسلط"}),l.jsx("select",{className:"w-full p-2.5 border rounded-lg dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",value:s.level,onChange:e=>n({...s,level:e.target.value}),children:m.map(e=>l.jsx("option",{value:e.value,children:e.label},e.value))})]}),l.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[l.jsx("div",{children:l.jsx(v,{label:"تاریخ مدرک",value:s.certDate,onChange:e=>n({...s,certDate:e})})}),l.jsx("div",{children:l.jsx(v,{label:"تاریخ انقضا",value:s.expiryDate,onChange:e=>n({...s,expiryDate:e}),disableFuture:!1})})]}),l.jsxs("div",{className:"flex gap-2 pt-4",children:[l.jsx("button",{type:"button",onClick:()=>o(!1),className:"flex-1 border py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition",children:"انصراف"}),l.jsxs("button",{type:"submit",disabled:c,className:"flex-1 bg-primary text-white py-2.5 rounded-lg hover:bg-red-800 flex items-center justify-center gap-2 transition disabled:bg-gray-400 disabled:cursor-not-allowed",children:[c?l.jsx(B,{className:"w-4 h-4 animate-spin"}):l.jsx(M,{className:"w-4 h-4"})," ثبت"]})]})]})})}),l.jsx(q,{title:"ماتریس مهارت پرسنل",icon:O,data:y,isLoading:N,onAdd:()=>o(!0),onReload:u,onDelete:E,selectedIds:S,onSelect:f,filterContent:F,onEdit:()=>{},onViewDetails:()=>{},exportName:"Skills",columns:[{header:"نام پرسنل",accessor:e=>e.full_name||"-",sortKey:"full_name"},{header:"کد پرسنلی",accessor:e=>e.personnel_code||"-",sortKey:"personnel_code"},{header:"نام مهارت",accessor:e=>e.skill_name,sortKey:"skill_name"},{header:"سطح",accessor:e=>A(e.level)||e.level||"-",sortKey:"level"},{header:"تاریخ مدرک",accessor:e=>e.certificate_date||"-",sortKey:"certificate_date"},{header:"تاریخ انقضا",accessor:e=>e.expiry_date||"-",sortKey:"expiry_date"}]})]})};export{V as Training,V as default};
