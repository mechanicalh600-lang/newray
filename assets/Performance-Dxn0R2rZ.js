import{r,w as D,s as u,j as s,V as J,Y as Q,a2 as Z,R as ee,ao as E,a0 as se,d as te,X as ae,_ as re,$ as ne,z as j,aa as le}from"./index-Ba5jVD6p.js";const de=({user:oe})=>{const[N,w]=r.useState([]),[b,M]=r.useState([]),[v,k]=r.useState(!1),[T,g]=r.useState("LIST"),[i,_]=r.useState([]),[A,h]=r.useState(!1),[m,F]=r.useState("ALL"),[x,K]=r.useState([]),[p,$]=r.useState([]),[S,O]=r.useState([]),[R,c]=r.useState(!1),[C,U]=r.useState(""),[f,I]=r.useState(!1),[a,d]=r.useState({personnelId:"",personnelName:"",unit:"",period:"",criteria:[]});r.useEffect(()=>{y(),D("evaluation_periods").then(e=>K(e||[])),D("personnel").then(e=>$(e||[])),u.from("evaluation_criteria").select("*").order("created_at").then(({data:e})=>O(e||[]))},[]),r.useEffect(()=>{let e=N;m!=="ALL"&&(e=e.filter(t=>t.period===m)),M(e)},[N,m]),r.useEffect(()=>{if(!a.personnelId){d(l=>({...l,criteria:[]}));return}const e=p.find(l=>l.id===a.personnelId),t=e==null?void 0:e.org_unit_id,n=S.filter(l=>!l.org_unit_id||l.org_unit_id===t);d(l=>({...l,criteria:n.map(o=>({id:o.id,label:o.title||o.name||"",max:Number(o.max_score)||10,score:0}))}))},[a.personnelId,p,S]);const y=async()=>{k(!0);const{data:e}=await u.from("performance_evaluations").select("*").order("created_at",{ascending:!1});e&&w(e),k(!1)},z=async()=>{await u.from("performance_evaluations").delete().in("id",i),w(e=>e.filter(t=>!i.includes(t.id))),_([]),h(!1)},V=()=>{const e=i.length>0?b.filter(l=>i.includes(l.id)):b,t=j.json_to_sheet(e),n=j.book_new();j.book_append_sheet(n,t,"Performance"),le(n,`performance_${Date.now()}.xlsx`)},W=e=>{d(t=>({...t,personnelId:e.id,personnelName:e.full_name||"",unit:e.unit||e.org_unit_name||"-"})),c(!1)},q=(e,t)=>{d(n=>{const l=[...n.criteria],o=l[e];if(!o)return n;const H=Math.max(0,Math.min(o.max,t));return l[e]={...o,score:H},{...n,criteria:l}})},L=a.criteria.reduce((e,t)=>e+((t==null?void 0:t.score)||0),0),P=a.criteria.reduce((e,t)=>e+((t==null?void 0:t.max)||0),0)||100,B=async e=>{if(e.preventDefault(),!(a.criteria.length===0||f||!a.personnelId||!a.period)){I(!0);try{const t=a.criteria.map(n=>({id:n.id,label:n.label,max:n.max,score:n.score}));await u.from("performance_evaluations").insert({personnel_id:a.personnelId,personnel_name:a.personnelName,unit:a.unit,period:a.period,total_score:L,max_possible_score:P,criteria_scores:t,status:"SUBMITTED"}),alert("ارزیابی با موفقیت ثبت و ارسال شد."),d({personnelId:"",personnelName:"",unit:"",period:"",criteria:[]}),g("LIST"),y()}catch(t){alert("خطا: "+((t==null?void 0:t.message)||"خطا در ذخیره"))}finally{I(!1)}}},X=(p||[]).filter(e=>{const t=(C||"").toLowerCase();return t?(e.full_name||"").toLowerCase().includes(t)||(e.unit||"").toLowerCase().includes(t)||(e.personnel_code||"").toLowerCase().includes(t):!0}),Y=s.jsxs(s.Fragment,{children:[i.length>0&&s.jsx("button",{onClick:()=>h(!0),className:"p-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition",title:"حذف",children:s.jsx(J,{className:"w-5 h-5"})}),s.jsx("button",{onClick:()=>g("NEW"),className:"p-2.5 bg-cyan-50 text-cyan-600 rounded-xl hover:bg-cyan-100 transition",title:"ارزیابی جدید",children:s.jsx(Q,{className:"w-5 h-5"})}),s.jsx("button",{onClick:V,className:"p-2.5 bg-green-50 text-green-600 rounded-xl hover:bg-green-100 transition",title:"خروجی اکسل",children:s.jsx(Z,{className:"w-5 h-5"})}),s.jsx("button",{onClick:y,className:"p-2.5 bg-gray-50 text-gray-600 rounded-xl hover:bg-gray-100 transition",title:"بروزرسانی",children:s.jsx(ee,{className:`w-5 h-5 ${v?"animate-spin":""}`})})]}),G=s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"دوره ارزیابی"}),s.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:m,onChange:e=>F(e.target.value),children:[s.jsx("option",{value:"ALL",children:"همه"}),(x||[]).map(e=>s.jsx("option",{value:e.title,children:e.title},e.id))]})]})});return T==="NEW"?s.jsxs("div",{className:"max-w-2xl mx-auto pb-24",children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white mb-6",children:[s.jsx(E,{className:"w-6 h-6 text-primary"})," ارزیابی عملکرد"]}),s.jsxs("form",{onSubmit:B,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm space-y-6 border border-gray-200 dark:border-gray-700",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("label",{className:"block text-sm font-bold text-gray-700 dark:text-gray-300",children:["انتخاب پرسنل ",s.jsx("span",{className:"text-red-500",children:"*"})]}),a.personnelName?s.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-gray-600 p-3 rounded-lg border border-primary/30",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-bold",children:a.personnelName}),s.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-300",children:["واحد: ",a.unit]})]}),s.jsx("button",{type:"button",onClick:()=>c(!0),className:"text-primary text-sm underline",children:"تغییر"})]}):s.jsxs("button",{type:"button",onClick:()=>c(!0),className:"w-full p-3 border-2 border-dashed border-gray-300 dark:border-gray-500 rounded-lg text-gray-500 hover:border-primary hover:text-primary transition flex items-center justify-center gap-2",children:[s.jsx(se,{className:"w-5 h-5"})," انتخاب از لیست پرسنل"]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("label",{className:"block text-sm font-bold text-gray-700 dark:text-gray-300",children:["دوره ارزیابی ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("select",{required:!0,value:a.period,onChange:e=>d({...a,period:e.target.value}),className:"w-full p-3 border rounded-lg bg-white dark:bg-gray-600 outline-none focus:ring-2 focus:ring-primary",children:[s.jsx("option",{value:"",children:x&&x.length>0?"انتخاب...":"دوره‌ای تعریف نشده"}),(x||[]).map(e=>s.jsx("option",{value:e.title,children:e.title},e.id))]})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"flex justify-between items-center border-b dark:border-gray-600 pb-2 mb-4",children:s.jsx("h3",{className:"font-bold",children:"شاخص‌های ارزیابی"})}),a.criteria.length>0?a.criteria.map((e,t)=>s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition",children:[s.jsxs("div",{className:"mb-2 md:mb-0",children:[s.jsxs("span",{className:"font-medium block",children:[t+1,". ",e.label]}),s.jsxs("span",{className:"text-xs text-gray-500",children:["حداکثر نمره قابل قبول: ",e.max]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"number",min:0,max:e.max,value:e.score,onChange:n=>q(t,Number(n.target.value)),className:"w-20 p-2 border rounded-lg text-center font-bold outline-none focus:ring-2 focus:ring-primary dark:bg-gray-600"}),s.jsxs("span",{className:"text-gray-400 text-sm",children:["/ ",e.max]})]})]},e.id)):s.jsx("p",{className:"text-center text-gray-400 py-4 border-2 border-dashed rounded-xl",children:"لطفا ابتدا پرسنل را انتخاب کنید تا فرم مربوطه بارگذاری شود."})]}),s.jsxs("div",{className:"sticky bottom-0 bg-white dark:bg-gray-800 pt-4 pb-2 border-t dark:border-gray-700",children:[s.jsxs("div",{className:"flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl mb-4",children:[s.jsx("span",{className:"font-bold text-lg text-blue-800 dark:text-blue-300",children:"مجموع امتیاز کسب شده"}),s.jsxs("div",{className:"flex items-baseline gap-1",children:[s.jsx("span",{className:"text-4xl font-black text-primary",children:L}),s.jsxs("span",{className:"text-gray-500",children:["/ ",P]})]})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{type:"button",onClick:()=>g("LIST"),className:"flex-1 border py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition",children:"انصراف"}),s.jsx("button",{type:"submit",disabled:a.criteria.length===0||f,className:"flex-[2] bg-primary text-white py-3 rounded-xl shadow-lg hover:bg-red-800 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:f?s.jsx(te,{className:"w-5 h-5 animate-spin"}):"ثبت نهایی و ارسال"})]})]})]}),R&&s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",onClick:()=>c(!1),children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center",children:[s.jsx("h3",{className:"font-bold",children:"انتخاب پرسنل"}),s.jsx("button",{onClick:()=>c(!1),children:s.jsx(ae,{className:"w-5 h-5"})})]}),s.jsx("input",{type:"text",value:C,onChange:e=>U(e.target.value),placeholder:"جستجو...",className:"m-4 p-2 border rounded-lg"}),s.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:X.slice(0,50).map(e=>s.jsxs("button",{type:"button",onClick:()=>W(e),className:"w-full text-right p-3 rounded-lg border hover:bg-gray-50 dark:hover:bg-gray-700 transition",children:[s.jsx("span",{className:"font-medium",children:e.full_name}),s.jsxs("span",{className:"text-xs text-gray-500 block",children:["واحد: ",e.unit||"-"]})]},e.id))})]})})]}):s.jsxs("div",{className:"max-w-7xl mx-auto pb-20 space-y-6",children:[s.jsx(re,{isOpen:A,onClose:()=>h(!1),onConfirm:z,title:"حذف ارزیابی",message:`آیا از حذف ${i.length} مورد انتخاب شده اطمینان دارید؟`}),s.jsx(ne,{title:"ارزیابی عملکرد پرسنل",icon:E,data:b,isLoading:v,extraActions:Y,selectedIds:i,onSelect:_,filterContent:G,columns:[{header:"کد پیگیری",accessor:e=>s.jsx("span",{className:"font-mono font-bold",children:e.tracking_code}),sortKey:"tracking_code"},{header:"نام پرسنل",accessor:e=>e.personnel_name,sortKey:"personnel_name"},{header:"واحد",accessor:e=>e.unit,sortKey:"unit"},{header:"دوره",accessor:e=>e.period,sortKey:"period"},{header:"امتیاز کل",accessor:e=>s.jsx("span",{className:"font-bold text-blue-600",children:e.total_score}),sortKey:"total_score"},{header:"وضعیت",accessor:e=>e.status,sortKey:"status"}]})]})};export{de as Performance,de as default};
