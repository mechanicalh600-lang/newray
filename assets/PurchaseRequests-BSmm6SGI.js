import{r as a,h as p,w as $,s as N,j as t,ai as D,X as O,a6 as V,a8 as M,d as G,F as W,a4 as J}from"./index-Ba5jVD6p.js";const j=["ستاد (دفتر مرکزی)","مجتمع (کارخانه)"],q=["عادی","فوری","بحرانی (توقف تولید)"],E=()=>{const o=new Date().getFullYear()-621,d=String(o).slice(-2).padStart(2,"0"),m=Math.floor(Math.random()*9e3)+1e3;return`${d}/${m}`},U=({user:i})=>{const[o,d]=a.useState([]),[m,R]=a.useState([]),[C,v]=a.useState(!1),[_,g]=a.useState("LIST"),[L,k]=a.useState([]),[c,P]=a.useState("ALL"),[l,I]=a.useState([]),[s,n]=a.useState({requestNumber:"",requestDate:p(),location:j[0],priority:q[0],desc:"",qty:0,unit:"عدد"}),[u,x]=a.useState(""),[b,w]=a.useState(!1);a.useEffect(()=>{h()},[]),a.useEffect(()=>{$("measurement_units").then(e=>I(e||[]))},[]),a.useEffect(()=>{let e=o;c!=="ALL"&&(e=e.filter(r=>r.status===c)),R(e)},[o,c]);const h=async()=>{v(!0);const{data:e}=await N.from("purchase_requests").select("*").order("created_at",{ascending:!1});e&&d(e),v(!1)},K=async e=>{await N.from("purchase_requests").delete().in("id",e),d(r=>r.filter(f=>!e.includes(f.id))),k([])},A=e=>{const r=e.replace(/[^0-9/]/g,"");r.length<=7&&(n(f=>({...f,requestNumber:r})),r.length>=6&&!/^\d{2}\/\d{4}$/.test(r)?x("فرمت: XX/XXXX (مثال: 03/1234)"):x(""))},y=()=>{n({requestNumber:E(),requestDate:p(),location:j[0],priority:q[0],desc:"",qty:0,unit:l&&l[0]?l[0].title:"عدد"}),x(""),g("LIST")},S=()=>{var e,r;return!!((e=s.requestNumber)!=null&&e.trim())&&!!((r=s.desc)!=null&&r.trim())&&!!s.qty&&s.qty>0&&!!s.unit&&!u},X=async e=>{if(e.preventDefault(),!(!S()||b)){w(!0);try{const{error:r}=await N.from("purchase_requests").insert({request_number:s.requestNumber.trim(),requester_id:i.id,requester_name:i.fullName||"ناشناس",request_date:s.requestDate,description:s.desc.trim(),qty:s.qty,unit:s.unit,location:s.location||null,priority:s.priority||null,status:"PENDING"});if(r)throw r;alert("درخواست خرید با موفقیت ثبت و به بازرگانی ارسال شد."),y(),h()}catch(r){alert("خطا: "+((r==null?void 0:r.message)||"خطا در ذخیره"))}finally{w(!1)}}},F=t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),t.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:c,onChange:e=>P(e.target.value),children:[t.jsx("option",{value:"ALL",children:"همه"}),t.jsx("option",{value:"PENDING",children:"در حال بررسی"}),t.jsx("option",{value:"APPROVED",children:"تایید شده"}),t.jsx("option",{value:"REJECTED",children:"رد شده"})]})]})}),T=e=>({PENDING:"در حال بررسی",APPROVED:"تایید شده",REJECTED:"رد شده"})[e]||e;return _==="NEW"?t.jsxs("div",{className:"max-w-2xl mx-auto pb-20",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white",children:[t.jsx(D,{className:"w-6 h-6 text-primary"})," درخواست خرید"]}),t.jsx("button",{onClick:y,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:t.jsx(O,{className:"w-5 h-5"})})]}),t.jsxs("form",{onSubmit:X,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm space-y-6 border border-gray-200 dark:border-gray-700",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:"درخواست دهنده"}),t.jsx("input",{type:"text",value:i.fullName,disabled:!0,className:"w-full p-2.5 border rounded-xl bg-gray-100 dark:bg-gray-700 cursor-not-allowed text-gray-500"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:["شماره درخواست (فرمت: 03/1234) ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",value:s.requestNumber,onChange:e=>A(e.target.value),maxLength:7,required:!0,placeholder:"03/1234",className:`w-full p-2.5 border rounded-xl font-mono text-center bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary ${u?"border-red-500 ring-1 ring-red-500":""}`}),u&&t.jsx("p",{className:"text-xs text-red-500 mt-1",children:u})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:"تاریخ درخواست"}),t.jsx(V,{value:s.requestDate,onChange:e=>n({...s,requestDate:e})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:"محل خرید"}),t.jsx("select",{value:s.location,onChange:e=>n({...s,location:e.target.value}),className:"w-full p-2.5 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",children:j.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:"اولویت"}),t.jsx("select",{value:s.priority,onChange:e=>n({...s,priority:e.target.value}),className:"w-full p-2.5 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",children:q.map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:["شرح درخواست ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsxs("div",{className:"relative",children:[t.jsx("textarea",{value:s.desc,onChange:e=>n({...s,desc:e.target.value}),required:!0,placeholder:"مشخصات فنی دقیق کالا یا خدمات...",className:"w-full h-32 p-3 pl-10 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary resize-none"}),t.jsx("button",{type:"button",className:"absolute left-3 bottom-3 text-gray-400 hover:text-primary transition-colors",title:"ضبط صوتی (به زودی)",children:t.jsx(M,{className:"w-5 h-5"})})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:["تعداد ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"number",value:s.qty||"",onChange:e=>n({...s,qty:Number(e.target.value)}),required:!0,min:.01,className:"w-full p-2.5 border rounded-xl text-center font-bold bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:["واحد ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("select",{value:s.unit,onChange:e=>n({...s,unit:e.target.value}),className:"w-full p-2.5 border rounded-xl bg-gray-50 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary",children:(l&&l.length>0?l:[{id:"1",title:"عدد"}]).map(e=>t.jsx("option",{value:e.title,children:e.title},e.id))})]})]}),t.jsxs("div",{className:"flex gap-3 pt-4 border-t dark:border-gray-700",children:[t.jsx("button",{type:"button",onClick:y,className:"flex-1 border py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition",children:"انصراف"}),t.jsxs("button",{type:"submit",disabled:!S()||b,className:"flex-[2] bg-primary text-white py-4 rounded-xl font-bold shadow-lg flex justify-center gap-2 transition disabled:bg-gray-400 disabled:cursor-not-allowed",children:[b?t.jsx(G,{className:"w-5 h-5 animate-spin"}):t.jsx(W,{className:"w-5 h-5"})," ثبت و ارسال به بازرگانی"]})]})]})]}):t.jsx(J,{title:"درخواست‌های خرید",icon:D,data:m,isLoading:C,onAdd:()=>{n(e=>({...e,requestNumber:E(),requestDate:p(),desc:"",qty:0,unit:l&&l[0]?l[0].title:"عدد"})),g("NEW")},onReload:h,onDelete:K,selectedIds:L,onSelect:k,filterContent:F,onEdit:()=>g("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),exportName:"PurchaseRequests",columns:[{header:"شماره درخواست",accessor:e=>t.jsx("span",{className:"font-mono font-bold",children:e.request_number}),sortKey:"request_number"},{header:"درخواست کننده",accessor:e=>e.requester_name,sortKey:"requester_name"},{header:"تاریخ درخواست",accessor:e=>e.request_date,sortKey:"request_date"},{header:"شرح کالا/خدمات",accessor:e=>e.description,sortKey:"description"},{header:"تعداد",accessor:e=>`${e.qty} ${e.unit||""}`,sortKey:"qty"},{header:"وضعیت",accessor:e=>T(e.status)||e.status,sortKey:"status"},{header:"محل",accessor:e=>e.location||"-",sortKey:"location"},{header:"اولویت",accessor:e=>e.priority||"-",sortKey:"priority"}]})};export{U as PurchaseRequests,U as default};
