import{u as F,r as o,s as p,j as e,a6 as f,a4 as z,bG as E,bj as I,ab as L}from"./index-Ba5jVD6p.js";import{c as R}from"./reportTemplates-DFawh_qo.js";const T=({user:_})=>{const x=F(),[u,g]=o.useState([]),[v,j]=o.useState([]),[N,m]=o.useState(!1),[w,n]=o.useState("LIST"),[y,b]=o.useState([]),[c,k]=o.useState(""),[d,C]=o.useState(""),[r,l]=o.useState({report_date:"",shift:"A",sample_code:"",sample_location:"",fe_percent:"",feo_percent:"",s_percent:"",moisture_percent:"",blaine:"",mesh_size:""});o.useEffect(()=>{R("lab-report","قالب پیش فرض گزارش آزمایشگاه"),i()},[]),o.useEffect(()=>{let t=u;c&&(t=t.filter(a=>a.report_date===c)),d&&(t=t.filter(a=>a.sample_code.includes(d))),j(t)},[u,c,d]);const i=async()=>{m(!0);const{data:t}=await p.from("lab_reports").select("*").order("created_at",{ascending:!1});t&&g(t),m(!1)},S=async t=>{await p.from("lab_reports").delete().in("id",t),g(a=>a.filter(s=>!t.includes(s.id))),b([])},D=e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(f,{label:"تاریخ",value:c,onChange:k})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"کد نمونه"}),e.jsx("input",{type:"text",className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:d,onChange:t=>C(t.target.value)})]})]});if(w==="NEW"){const t=async()=>{if(!r.report_date||!r.sample_code.trim()){alert("تاریخ و کد نمونه الزامی است.");return}const s={tracking_code:await L("LAB-"),...r,operator_id:_.id||null,fe_percent:r.fe_percent?Number(r.fe_percent):null,feo_percent:r.feo_percent?Number(r.feo_percent):null,s_percent:r.s_percent?Number(r.s_percent):null,moisture_percent:r.moisture_percent?Number(r.moisture_percent):null,blaine:r.blaine?Number(r.blaine):null,mesh_size:r.mesh_size?Number(r.mesh_size):null},{error:h}=await p.from("lab_reports").insert([s]);if(h){alert(`خطا در ثبت: ${h.message}`);return}alert("گزارش آزمایشگاه ثبت شد."),l({report_date:"",shift:"A",sample_code:"",sample_location:"",fe_percent:"",feo_percent:"",s_percent:"",moisture_percent:"",blaine:"",mesh_size:""}),await i(),n("LIST")};return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-xl shadow space-y-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"ثبت گزارش آزمایشگاه"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(f,{label:"تاریخ گزارش",value:r.report_date,onChange:a=>l(s=>({...s,report_date:a}))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"شیفت"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:r.shift,onChange:a=>l(s=>({...s,shift:a.target.value})),children:[e.jsx("option",{value:"A",children:"شیفت A"}),e.jsx("option",{value:"B",children:"شیفت B"}),e.jsx("option",{value:"C",children:"شیفت C"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"کد نمونه *"}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:r.sample_code,onChange:a=>l(s=>({...s,sample_code:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"محل نمونه‌برداری"}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",value:r.sample_location,onChange:a=>l(s=>({...s,sample_location:a.target.value}))})]}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"Fe %",value:r.fe_percent,onChange:a=>l(s=>({...s,fe_percent:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"FeO %",value:r.feo_percent,onChange:a=>l(s=>({...s,feo_percent:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"S %",value:r.s_percent,onChange:a=>l(s=>({...s,s_percent:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"Moisture %",value:r.moisture_percent,onChange:a=>l(s=>({...s,moisture_percent:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"Blaine",value:r.blaine,onChange:a=>l(s=>({...s,blaine:a.target.value}))}),e.jsx("input",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-700",placeholder:"Mesh Size",value:r.mesh_size,onChange:a=>l(s=>({...s,mesh_size:a.target.value}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:t,className:"bg-primary text-white px-4 py-2 rounded-lg",children:"ثبت نهایی"}),e.jsx("button",{onClick:()=>n("LIST"),className:"bg-gray-200 px-4 py-2 rounded-lg",children:"بازگشت"})]})]})}return e.jsx(z,{title:"گزارشات آزمایشگاه",icon:E,data:v,isLoading:N,onAdd:()=>n("NEW"),onReload:i,onDelete:S,selectedIds:y,onSelect:b,filterContent:D,onEdit:()=>n("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),onPrint:t=>I(x,"lab-report",t),exportName:"LabReports",columns:[{header:"کد گزارش",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code}),sortKey:"tracking_code"},{header:"تاریخ",accessor:t=>t.report_date,sortKey:"report_date"},{header:"کد نمونه",accessor:t=>t.sample_code,sortKey:"sample_code"},{header:"Fe %",accessor:t=>t.fe_percent,sortKey:"fe_percent"},{header:"FeO %",accessor:t=>t.feo_percent,sortKey:"feo_percent"},{header:"S %",accessor:t=>t.s_percent,sortKey:"s_percent"}]})};export{T as LabReport,T as default};
