import{r,s as g,j as e,ag as _,X as E,h as W,a8 as z,d as X,ah as q,a4 as Z,ab as L}from"./index-Ba5jVD6p.js";import{P as H}from"./paperclip-CYuFmfPe.js";const D="technical-documents",C=5,Q=["pdf","jpg","jpeg"],te=({user:u})=>{const[j,N]=r.useState([]),[I,P]=r.useState([]),[T,v]=r.useState(!1),[A,i]=r.useState("LIST"),[F,S]=r.useState([]),[m,R]=r.useState("ALL"),[o,w]=r.useState(""),[x,y]=r.useState([]),[h,k]=r.useState(!1),d=r.useRef(null);r.useEffect(()=>{f()},[]),r.useEffect(()=>{let t=j;m!=="ALL"&&(t=t.filter(a=>a.status===m)),P(t)},[j,m]);const f=async()=>{v(!0);const{data:t}=await g.from("technical_suggestions").select("*").order("created_at",{ascending:!1});t&&N(t),v(!1)},G=async t=>{await g.from("technical_suggestions").delete().in("id",t),N(a=>a.filter(l=>!t.includes(l.id))),S([])},K=()=>{var t;return(t=d.current)==null?void 0:t.click()},U=t=>{const a=Array.from(t.target.files||[]),l=[];for(const s of a){if(s.size>C*1024*1024){alert(`حداکثر حجم هر فایل ${C} مگابایت است.`);continue}const n=(s.name.split(".").pop()||"").toLowerCase();if(!Q.includes(n)){alert(`فرمت مجاز: PDF, JPG. فایل ${s.name} رد شد.`);continue}l.push(s)}y(s=>[...s,...l]),d.current&&(d.current.value="")},$=t=>y(a=>a.filter((l,s)=>s!==t)),p=()=>{w(""),y([]),d.current&&(d.current.value="")},M=async t=>{if(t.preventDefault(),!o.trim()||h)return;k(!0);const a=[];try{if(x.length>0)for(const n of x){const c=`suggestions/${Date.now()}_${Math.random().toString(36).slice(2)}_${n.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,{data:b,error:O}=await g.storage.from(D).upload(c,n,{upsert:!1});if(!O&&(b!=null&&b.path)){const{data:V}=g.storage.from(D).getPublicUrl(b.path);a.push({name:n.name,url:V.publicUrl})}}const l=await L("SUG"),{error:s}=await g.from("technical_suggestions").insert({tracking_code:l,user_id:u.id,user_name:u.fullName||"ناشناس",description:o.trim(),attachments:a});if(s)throw s;alert("پیشنهاد فنی با موفقیت ثبت شد."),p(),i("LIST"),f()}catch(l){const s=(l==null?void 0:l.message)||"";if(s.includes("Bucket not found")||s.includes("bucket")||s.includes("Storage")){const n=await L("SUG"),{error:c}=await g.from("technical_suggestions").insert({tracking_code:n,user_id:u.id,user_name:u.fullName||"ناشناس",description:o.trim(),attachments:[]});if(c){alert("خطا: "+((c==null?void 0:c.message)||c));return}alert("پیشنهاد ثبت شد. برای آپلود فایل‌ها، باکت technical-documents را در Supabase Storage بسازید."),p(),i("LIST"),f()}else alert("خطا: "+s)}finally{k(!1)}},B=t=>({PENDING:"در حال بررسی",APPROVED:"تایید شده",REJECTED:"رد شده"})[t]||t,J=e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"وضعیت"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg bg-white dark:bg-gray-800",value:m,onChange:t=>R(t.target.value),children:[e.jsx("option",{value:"ALL",children:"همه"}),e.jsx("option",{value:"PENDING",children:"در حال بررسی"}),e.jsx("option",{value:"APPROVED",children:"تایید شده"}),e.jsx("option",{value:"REJECTED",children:"رد شده"})]})]})});return A==="NEW"?e.jsxs("div",{className:"max-w-2xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2 text-gray-800 dark:text-white",children:[e.jsx(_,{className:"w-6 h-6 text-primary"})," ثبت پیشنهاد فنی"]}),e.jsx("button",{onClick:()=>{p(),i("LIST")},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(E,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:M,className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm space-y-6 border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-500 mb-1",children:"پیشنهاد دهنده"}),e.jsx("input",{type:"text",value:u.fullName,disabled:!0,className:"w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-500 mb-1",children:"تاریخ ثبت"}),e.jsx("input",{type:"text",value:W(),disabled:!0,className:"w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-500"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["شرح پیشنهاد فنی ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:o,onChange:t=>w(t.target.value),className:"w-full h-40 p-3 pl-10 border rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none",placeholder:"پیشنهاد خود را جهت بهبود عملکرد تجهیزات یا فرآیندها بنویسید...",required:!0}),e.jsx("button",{type:"button",className:"absolute bottom-3 left-3 p-2 text-gray-400 hover:text-primary transition-colors",title:"ضبط صوتی (به زودی)",children:e.jsx(z,{className:"w-6 h-6"})})]})]}),e.jsxs("div",{children:[e.jsx("input",{type:"file",ref:d,multiple:!0,className:"hidden",accept:".pdf,.jpg,.jpeg",onChange:U}),e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsxs("button",{type:"button",onClick:K,className:"flex items-center gap-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg transition hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx(H,{className:"w-4 h-4"})," افزودن مستندات"]}),e.jsx("span",{className:"text-xs text-gray-400",children:"فایل‌های مجاز: PDF, JPG (max 5MB)"})]}),x.length>0&&e.jsx("ul",{className:"mt-3 space-y-2",children:x.map((t,a)=>e.jsxs("li",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-300",children:t.name}),e.jsx("button",{type:"button",onClick:()=>$(a),className:"text-red-500 hover:text-red-700",children:e.jsx(E,{className:"w-4 h-4"})})]},a))})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:()=>{p(),i("LIST")},className:"flex-1 border py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700",children:"انصراف"}),e.jsxs("button",{type:"submit",disabled:!o.trim()||h,className:`flex-[2] text-white py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition ${!o.trim()||h?"bg-gray-400 cursor-not-allowed opacity-70":"bg-primary hover:bg-red-800"}`,children:[h?e.jsx(X,{className:"w-5 h-5 animate-spin"}):e.jsx(q,{className:"w-5 h-5"})," ثبت پیشنهاد"]})]})]})]}):e.jsx(Z,{title:"نظام پیشنهادات فنی",icon:_,data:I,isLoading:T,onAdd:()=>i("NEW"),onReload:f,onDelete:G,selectedIds:F,onSelect:S,filterContent:J,onEdit:()=>i("NEW"),onViewDetails:()=>alert("مشاهده جزئیات"),exportName:"Suggestions",columns:[{header:"کد رهگیری",accessor:t=>e.jsx("span",{className:"font-mono font-bold",children:t.tracking_code||"-"}),sortKey:"tracking_code"},{header:"پیشنهاد دهنده",accessor:t=>t.user_name||"ناشناس",sortKey:"user_name"},{header:"شرح پیشنهاد",accessor:t=>(t.description||"").slice(0,80)+((t.description||"").length>80?"...":""),sortKey:"description"},{header:"وضعیت",accessor:t=>B(t.status)||t.status,sortKey:"status"},{header:"تاریخ ثبت",accessor:t=>t.created_at?new Date(t.created_at).toLocaleDateString("fa-IR"):"-",sortKey:"created_at"}]})};export{te as Suggestions,te as default};
