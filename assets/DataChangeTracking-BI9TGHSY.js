import{r as l,j as e,bQ as k,a2 as S,ay as E,s as $,z as g,aa as C}from"./index-Ba5jVD6p.js";import{R as L}from"./refresh-ccw-7aaP1mjM.js";import{I as O}from"./info-CFSfHgcC.js";const y=d=>({user_groups:"گروه‌های کاربری",personnel:"پرسنل",org_chart:"چارت سازمانی",equipment_classes:"کلاس تجهیزات",equipment_groups:"گروه تجهیزات",equipment:"تجهیزات",parts:"قطعات",activity_cards:"کارت فعالیت‌ها",work_orders:"دستورکارها",shift_reports:"گزارشات شیفت",lab_reports:"گزارشات آزمایشگاه",warehouse_reports:"گزارشات انبار"})[d]||d,T=()=>{const[d,h]=l.useState([]),[x,p]=l.useState(!1),[f,b]=l.useState(""),[o,_]=l.useState(""),[w,u]=l.useState(!0),N=(s,a,r)=>{if(r==="INSERT"){const n=Object.keys(a||{});return{changedFields:n,summary:n.length?`ایجاد رکورد با ${n.length} فیلد`:"ایجاد رکورد"}}if(r==="DELETE")return{changedFields:Object.keys(s||{}),summary:"حذف رکورد"};const t=s||{},i=a||{},m=Array.from(new Set([...Object.keys(t),...Object.keys(i)])).filter(n=>JSON.stringify(t[n])!==JSON.stringify(i[n]));return{changedFields:m,summary:m.length?`ویرایش ${m.length} فیلد`:"ویرایش بدون تغییر محسوس"}},j=async()=>{p(!0),b("");try{const{data:s,error:a}=await $.from("data_change_audit").select("id, table_name, record_id, operation, changed_by, changed_at, old_data, new_data").order("changed_at",{ascending:!1}).limit(2e3);if(a)throw a;const r=(s||[]).map(t=>{const i=N(t.old_data,t.new_data,t.operation);return{id:t.id,table:t.table_name,record_id:t.record_id||"-",operation:t.operation,changed_by:t.changed_by||"-",changed_at:t.changed_at?new Date(t.changed_at).toLocaleString("fa-IR"):"-",changed_fields:i.changedFields,summary:i.summary}});u(!0),h(r)}catch{u(!1),b("جدول audit هنوز فعال نیست یا دسترسی ندارد. اسکریپت SQL ردیابی تغییرات را اجرا کنید."),h([])}finally{p(!1)}};l.useEffect(()=>{j()},[]);const c=l.useMemo(()=>{if(!o.trim())return d;const s=o.toLowerCase();return d.filter(a=>`${a.table} ${a.record_id} ${a.operation} ${a.changed_by} ${a.changed_at} ${a.summary} ${a.changed_fields.join(" ")}`.toLowerCase().includes(s))},[d,o]),v=()=>{if(c.length===0)return;const s=g.json_to_sheet(c.map(r=>({جدول:y(r.table),عملیات:r.operation,"شناسه رکورد":r.record_id,تغییردهنده:r.changed_by,"زمان تغییر":r.changed_at,خلاصه:r.summary,"فیلدهای تغییر یافته":r.changed_fields.join(", ")}))),a=g.book_new();g.book_append_sheet(a,s,"data_changes"),C(a,`data_changes_${Date.now()}.xlsx`)};return e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 pb-20",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm",children:e.jsx(k,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"ردیابی تغییرات اطلاعات"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"نمایش کامل تغییرات با Audit واقعی (Insert/Update/Delete)"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:j,className:"px-3 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm font-bold inline-flex items-center gap-1",children:[e.jsx(L,{className:`w-4 h-4 ${x?"animate-spin":""}`}),"بروزرسانی"]}),e.jsxs("button",{onClick:v,className:"px-3 py-2 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 text-sm font-bold inline-flex items-center gap-1",children:[e.jsx(S,{className:"w-4 h-4"}),"خروجی اکسل"]})]})]}),!w&&e.jsxs("div",{className:"rounded-xl border border-amber-200 bg-amber-50 text-amber-800 px-4 py-3 text-sm inline-flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4"}),f]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50 dark:bg-gray-900 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-700 dark:text-gray-200",children:["تعداد رویدادها: ",c.length]}),e.jsxs("div",{className:"relative w-72",children:[e.jsx(E,{className:"w-4 h-4 text-gray-400 absolute right-3 top-2.5"}),e.jsx("input",{value:o,onChange:s=>_(s.target.value),placeholder:"جستجو در تغییرات...",className:"w-full pr-9 pl-3 py-2 text-sm border rounded-lg bg-white dark:bg-gray-700 outline-none"})]})]}),e.jsx("div",{className:"overflow-auto max-h-[70vh]",children:e.jsxs("table",{className:"w-full text-sm text-right",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-100 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3",children:"جدول"}),e.jsx("th",{className:"p-3",children:"عملیات"}),e.jsx("th",{className:"p-3",children:"شناسه رکورد"}),e.jsx("th",{className:"p-3",children:"تغییردهنده"}),e.jsx("th",{className:"p-3",children:"زمان تغییر"}),e.jsx("th",{className:"p-3",children:"خلاصه"}),e.jsx("th",{className:"p-3",children:"فیلدهای تغییر یافته"})]})}),e.jsx("tbody",{className:"divide-y",children:c.length>0?c.map((s,a)=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/40",children:[e.jsx("td",{className:"p-3 whitespace-nowrap",children:y(s.table)}),e.jsx("td",{className:"p-3 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-bold ${s.operation==="UPDATE"?"bg-amber-100 text-amber-700":s.operation==="DELETE"?"bg-red-100 text-red-700":"bg-emerald-100 text-emerald-700"}`,children:s.operation})}),e.jsx("td",{className:"p-3 whitespace-nowrap ltr text-left",children:s.record_id}),e.jsx("td",{className:"p-3 whitespace-nowrap",children:s.changed_by}),e.jsx("td",{className:"p-3 whitespace-nowrap",children:s.changed_at}),e.jsx("td",{className:"p-3 min-w-[220px]",children:s.summary}),e.jsx("td",{className:"p-3 min-w-[260px] text-xs",children:s.changed_fields.join(", ")||"-"})]},`${s.table}-${s.id}-${a}`)):e.jsx("tr",{children:e.jsx("td",{className:"p-10 text-center text-gray-400",colSpan:7,children:x?"در حال دریافت...":"موردی یافت نشد"})})})]})})]})]})};export{T as DataChangeTracking,T as default};
