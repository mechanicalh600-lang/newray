# راهنمای دیپلوی رای‌نو روی لیارا

این سند مراحل دیپلوی اپلیکیشن رای‌نو (Vite + React) روی [لیارا](https://liara.ir) را شرح می‌دهد.

---

## پیش‌نیاز

- اکانت در [پنل لیارا](https://console.liara.ir)
- پروژه با `npm install` و تست محلی (`npm run dev`) بدون خطا

---

## دو روش دیپلوی

| روش | دستور بیلد | خروجی | پلتفرم در لیارا | مزیت |
|-----|-------------|--------|------------------|------|
| **استاتیک** (پیشنهادی) | `npm run build:liara:static` | `liara/newray-static.zip` | **Static** | سریع، بدون بیلد روی سرور |
| **React** | `npm run build:liara` یا `npm run build:liara:archiver` | `liara/newray.zip` | **React** | بیلد روی سرور لیارا، مناسب برای CI/CD |

---

## روش ۱: دیپلوی استاتیک (پیشنهادی)

اپ از قبل روی سیستم شما بیلد می‌شود و فقط فایل‌های خروجی به لیارا فرستاده می‌شوند. مناسب برای دامنه ریشه و SPA.

### مرحله ۱: ساخت برنامه در پنل لیارا

1. وارد [console.liara.ir](https://console.liara.ir) شوید.
2. **ایجاد برنامه** → پلتفرم **Static** را انتخاب کنید.
3. نام برنامه (مثلاً `newray`) و در صورت نیاز منطقه را تنظیم کنید و برنامه را بسازید.

### مرحله ۲: بیلد و آپلود

در ریشه پروژه:

```bash
npm run build:liara:static
```

فایل `liara/newray-static.zip` ساخته می‌شود. در برنامه‌ی Static در پنل لیارا روی **استقرار جدید** کلیک کنید و این فایل zip را با **Drag & Drop** آپلود کنید.

### مرحله ۳: متغیرهای محیطی (اختیاری برای استاتیک)

در روش استاتیک، مقادیر `VITE_*` داخل همان بیلد قرار می‌گیرند. اسکریپت با `--mode liara` اجرا می‌شود، پس Vite از فایل **`.env.liara`** استفاده می‌کند. قبل از `npm run build:liara:static` فایل `.env.liara` را (کپی از `.env.example`) بسازید و مقادیر را پر کنید؛ یا از `.env.production` استفاده کنید. این فایل‌ها در git commit نمی‌شوند. برای تغییر مقادیر در هر استقرار، از روش React و متغیرهای محیطی پنل لیارا استفاده کنید.

---

## روش ۲: دیپلوی با پلتفرم React

سورس پروژه (بدون `node_modules`) به لیارا فرستاده می‌شود و لیارا خودش `npm install` و `npm run build` را اجرا می‌کند.

### مرحله ۱: ساخت برنامه در پنل لیارا

1. وارد [console.liara.ir](https://console.liara.ir) شوید.
2. **ایجاد برنامه** → پلتفرم **React** را انتخاب کنید.
3. نام برنامه را وارد و برنامه را بسازید.

### مرحله ۲: بیلد zip و آپلود

در ریشه پروژه یکی از این دو را اجرا کنید:

```bash
npm run build:liara
# یا
npm run build:liara:archiver
```

فایل `liara/newray.zip` ساخته می‌شود. در برنامه‌ی React در پنل لیارا روی **استقرار جدید** کلیک کنید و این فایل zip را آپلود کنید.

### مرحله ۳: متغیرهای محیطی در پنل لیارا

در برنامه → **تنظیمات** → **متغیرهای محیطی** این مقادیر را اضافه کنید:

| متغیر | توضیح |
|--------|--------|
| `VITE_SUPABASE_URL` | آدرس پروژه Supabase |
| `VITE_SUPABASE_ANON_KEY` | کلید آنون Supabase |
| `VITE_GEMINI_API_KEY` | (اختیاری) کلید API Gemini برای چت/هوش مصنوعی |

اگر اپ روی **دامنه ریشه** (مثلاً `https://yourdomain.ir`) سرو می‌شود، این را هم اضافه کنید:

| متغیر | مقدار |
|--------|--------|
| `VITE_BASE_URL` | `/` |

بدون این متغیر، مقدار پیش‌فرض در کد `vite.config` برابر `/newray/` است.

---

## دامنه و دسترسی

- بعد از استقرار موفق، آدرس پیش‌فرض برنامه چیزی شبیه `https://your-app.liara.ir` خواهد بود.
- برای اتصال دامنه اختصاصی: برنامه → **دامنه‌ها** و طبق [مستندات اتصال دامنه](https://docs.liara.ir/paas/domains/about/) عمل کنید.

---

## عیب‌یابی

- **خطای ۴۰۴ روی روت‌های SPA:** در روش استاتیک، اسکریپت `build:liara:static` به‌طور موقت یک `404.html` مناسب برای دامنه ریشه تولید می‌کند. اگر خودتان دستی بیلد می‌کنید، مطمئن شوید `public/404.html` برای SPA (redirect به index) تنظیم شده است.
- **خطای بیلد روی پلتفرم React:** در برنامه لیارا به **تاریخچه استقرار** بروید و لاگ بیلد را بررسی کنید. معمولاً مشکل از نسخه Node یا وابستگی‌هاست.
- **متغیرهای محیطی خالی:** در روش React حتماً `VITE_SUPABASE_URL` و `VITE_SUPABASE_ANON_KEY` را در پنل لیارا تنظیم کنید و یک بار **استقرار مجدد** انجام دهید.

---

## لینک‌های مفید

- [مستندات React در لیارا](https://docs.liara.ir/paas/react/getting-started/)
- [مستندات Static در لیارا](https://docs.liara.ir/paas/static/getting-started/)
- [استقرار برنامه React](https://docs.liara.ir/paas/react/how-tos/deploy-app/)
- [استقرار برنامه Static](https://docs.liara.ir/paas/static/how-tos/deploy-app/)
- [متغیرهای محیطی در React](https://docs.liara.ir/paas/react/how-tos/set-envs/)
